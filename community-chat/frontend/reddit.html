<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>College Connect</title>
<style>
/* === CSS Variables & Design System === */
:root {
  --primary-purple: #7C3AED;
  --primary-blue: #3B82F6;
  --accent-purple: #A78BFA;
  --accent-blue: #60A5FA;
  --bg-light: #F3F4F6;
  --bg-white: #FFFFFF;
  --text-dark: #1F2937;
  --text-gray: #6B7280;
  --text-light: #9CA3AF;
  --border-light: #E5E7EB;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
  --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
  --gradient-primary: linear-gradient(135deg, #7C3AED 0%, #3B82F6 100%);
  --gradient-accent: linear-gradient(135deg, #A78BFA 0%, #60A5FA 100%);
  --gradient-soft: linear-gradient(135deg, #EDE9FE 0%, #DBEAFE 100%);
}

* { box-sizing: border-box; }

body { 
  margin: 0; 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-light);
  color: var(--text-dark);
  line-height: 1.6;
}

/* === Navbar === */
.navbar {
  background: var(--gradient-primary);
  color: #fff;
  padding: 14px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 22px;
  font-weight: 700;
  box-shadow: var(--shadow-md);
  position: sticky;
  top: 0;
  z-index: 1000;
  backdrop-filter: blur(10px);
}

.navbar button {
  background: rgba(255,255,255,0.2);
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
  padding: 8px 20px;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
  cursor: pointer;
}
.nav-back-btn {
    background: none !important;
    border: none !important; 
    color: white !important;
    font-size: 24px !important;
    padding: 0 10px !important;
}

.navbar button:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* === Search === */
.search-container { 
  flex: 1; 
  max-width: 600px; 
  margin: 0 20px; 
  position: relative;
}

.search-input {
  width: 100%;
  padding: 10px 20px;
  border-radius: 24px;
  border: none;
  font-size: 14px;
  outline: none;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
}

.search-input:focus {
  box-shadow: 0 0 0 3px rgba(124,58,237,0.3);
}

.search-results {
  position: absolute;
  background: var(--bg-white);
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  margin-top: 8px;
  max-height: 400px;
  overflow-y: auto;
  width: 100%;
  display: none;
  z-index: 1000;
}

.search-result-item {
  padding: 14px 18px;
  cursor: pointer;
  color: var(--text-dark);
  border-bottom: 1px solid var(--border-light);
  transition: all 0.2s ease;
}

.search-result-item:hover {
  background: var(--gradient-soft);
  padding-left: 24px;
}

.search-result-item:last-child { border-bottom: none; }

/* === Layout === */
.container { display: flex; min-height: calc(100vh - 60px); }

.sidebar {
  width: 280px;
  background: var(--bg-white);
  padding: 24px 16px;
  border-right: 1px solid var(--border-light);
  position: sticky;
  top: 60px;
  height: calc(100vh - 60px);
  overflow-y: auto;
  box-shadow: var(--shadow-sm);
}

.sidebar h3 {
  color: var(--text-gray);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 24px 0 12px 0;
  font-weight: 600;
}

.sidebar button {
  width: 100%;
  text-align: left;
  padding: 12px 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-size: 15px;
  font-weight: 500;
  margin-bottom: 6px;
  transition: all 0.2s ease;
  background: transparent;
  color: var(--text-dark);
}

.sidebar button:hover {
  background: var(--gradient-soft);
  transform: translateX(4px);
}

.sidebar p {
  padding: 12px 16px;
  margin: 4px 0;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: var(--text-dark);
  font-size: 14px;
}

.sidebar p:hover {
  background: var(--gradient-soft);
  transform: translateX(4px);
}

.sidebar-hidden { display: none; }

.main {
  flex: 1;
  padding: 32px 40px;
  max-width: 1200px;
  margin: 0 auto;
}

/* === Buttons === */
button {
  padding: 10px 18px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  font-size: 14px;
}

.createBtn {
  background: var(--gradient-primary);
  color: #fff;
  box-shadow: var(--shadow-md);
}

.createBtn:hover {
  transform: scale(1.02);
  box-shadow: var(--shadow-lg);
}

.deleteBtn {
  background: #FEE2E2;
  color: #DC2626;
}

.deleteBtn:hover {
  background: #FECACA;
}

/* === Post Cards === */
.postCard {
  background: var(--bg-white);
  padding: 24px;
  border-radius: 16px;
  border: 1px solid var(--border-light);
  margin-bottom: 20px;
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
}

.postCard:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.postTitle {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-dark);
  margin-bottom: 8px;
}

.postAuthor {
  color: var(--text-gray);
  font-size: 13px;
  margin-bottom: 12px;
}

.post-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.postImg-container {
  width: 100%;
  max-height: 512px;
  background: #000;
  margin: 16px 0;
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
}

.postImg {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  display: block;
}

.post-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border-light);
}

.action-btn {
  background: transparent;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 13px;
  color: var(--text-gray);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  transition: all 0.2s ease;
}

.action-btn:hover {
  background: var(--gradient-soft);
  color: var(--primary-purple);
}

/* === Vote Buttons === */
.voteBtn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 20px;
  padding: 6px;
  transition: all 0.2s ease;
  border-radius: 6px;
}

.voteBtn:hover {
  background: var(--gradient-soft);
  transform: scale(1.1);
}

.voteBtn.active {
  font-weight: bold;
  transform: scale(1.2);
}

.score {
  font-size: 14px;
  font-weight: 700;
  margin: 4px 0;
  color: var(--text-dark);
}

.up.active { color: var(--primary-purple); }
.down.active { color: var(--primary-blue); }

/* === Comments === */
.commentBox {
  background: var(--gradient-soft);
  padding: 14px;
  border-radius: 10px;
  margin-top: 12px;
  border-left: 3px solid var(--primary-purple);
}

.replyBtn {
  color: var(--primary-blue);
  cursor: pointer;
  margin-left: 8px;
  font-weight: 600;
  transition: color 0.2s ease;
}

.replyBtn:hover {
  color: var(--primary-purple);
}

/* === Modals === */
.modalBg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(31,41,55,0.7);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal {
  background: var(--bg-white);
  padding: 28px;
  border-radius: 16px;
  width: 480px;
  max-width: 90vw;
  box-shadow: var(--shadow-xl);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal h3 {
  margin-top: 0;
  color: var(--text-dark);
  font-size: 20px;
}

/* === Inputs === */
input, textarea {
  width: calc(100% - 20px);
  padding: 12px;
  margin-top: 8px;
  border: 1px solid var(--border-light);
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
  transition: all 0.2s ease;
}

input:focus, textarea:focus {
  outline: none;
  border-color: var(--primary-purple);
  box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
}

textarea {
  resize: vertical;
  min-height: 100px;
}

/* === Utility Classes === */
.small {
  font-size: 13px;
  color: var(--text-gray);
}

/* === Community Page === */
.community-page { display: none; }

.community-header {
  background: var(--bg-white);
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 24px;
  box-shadow: var(--shadow-md);
}

.community-banner {
  height: 120px;
  background: var(--gradient-primary);
}

.community-info {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-top: -40px;
  padding: 0 32px 24px;
  padding-top: 10px;
}

.community-icon {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border: 5px solid var(--bg-white);
  background: var(--bg-white);
  object-fit: cover;
  box-shadow: var(--shadow-md);
}

.community-details { flex: 1; }

.community-name {
  font-size: 32px;
  font-weight: 700;
  margin: 12px 0 6px 0;
  color: #1F2937;
}

.community-stats {
  color: #1F2937;
  font-size: 14px;
  font-weight: 500;
}

.join-btn {
  background: var(--gradient-primary);
  color: #fff;
  padding: 10px 28px;
  border-radius: 24px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: var(--shadow-sm);
}

.join-btn:hover {
  transform: scale(1.05);
  box-shadow: var(--shadow-md);
}

.join-btn.joined {
  background: var(--bg-white);
  color: var(--primary-purple);
  border: 2px solid var(--primary-purple);
}

.community-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

/* === Members List === */
.members-list {
  margin-top: 24px;
  padding: 24px;
  background: var(--bg-white);
  border-radius: 16px;
  box-shadow: var(--shadow-sm);
}

.members-list h3 {
  margin: 0 0 20px 0;
  font-size: 18px;
  color: var(--text-dark);
}

.member-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border-light);
  transition: all 0.2s ease;
}

.member-item:last-child { border-bottom: none; }

.member-item:hover {
  padding-left: 8px;
  background: var(--gradient-soft);
  margin: 0 -12px;
  padding-left: 20px;
  padding-right: 12px;
  border-radius: 8px;
}

.member-name {
  font-weight: 600;
  color: var(--text-dark);
}

.member-role {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 12px;
  background: var(--gradient-soft);
  color: var(--primary-blue);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.member-role.admin {
  background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
  color: #DC2626;
}

.member-role.subadmin {
  background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
  color: #2563EB;
}

/* === Profile === */
.profile-container {
  display: none;
  padding: 32px;
  background: var(--bg-white);
  border-radius: 16px;
  max-width: 700px;
  margin: 24px auto;
  box-shadow: var(--shadow-md);
}

.avatar-large {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid transparent;
  background-image: var(--gradient-primary);
  background-origin: border-box;
  background-clip: padding-box, border-box;
  box-shadow: var(--shadow-md);
}

/* === Menus === */
.cmt-menu-btn, .comm-menu-btn {
  cursor: pointer;
  font-weight: bold;
  margin-left: 12px;
  padding: 4px 8px;
  user-select: none;
  color: var(--text-gray);
  border-radius: 6px;
  transition: all 0.2s ease;
}

.cmt-menu-btn:hover, .comm-menu-btn:hover {
  background: var(--gradient-soft);
  color: var(--primary-purple);
}

.cmt-menu, .comm-menu {
  position: absolute;
  background: var(--bg-white);
  border: 1px solid var(--border-light);
  padding: 8px;
  display: none;
  z-index: 100;
  box-shadow: var(--shadow-lg);
  border-radius: 10px;
  min-width: 180px;
}

.cmt-menu div, .comm-menu div {
  padding: 8px 14px;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s ease;
  font-size: 14px;
}

/* === Toasts === */
.toast-container {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.toast {
  background: white;
  color: #333;
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  gap: 10px;
  animation: slideIn 0.3s ease-out;
  border-left: 4px solid #6200ee;
  min-width: 250px;
  font-family: 'Segoe UI', sans-serif;
  font-size: 14px;
}
.toast-error { border-left-color: #ef5350; }
.toast-success { border-left-color: #66bb6a; }

@keyframes slideIn {
  from { opacity: 0; transform: translateX(100%); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes fadeOut {
  to { opacity: 0; transform: translateX(100%); }
}

.cmt-menu div:hover, .comm-menu div:hover {
  background: var(--gradient-soft);
  color: var(--primary-purple);
  padding-left: 18px;
}

/* === Post Community Link === */
.post-comm-link {
  font-weight: 600;
  color: var(--primary-purple);
  cursor: pointer;
  transition: color 0.2s ease;
}

.post-comm-link:hover {
  color: var(--primary-blue);
  text-decoration: underline;
}

.post-comm-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  object-fit: cover;
  cursor: pointer;
  border: 2px solid var(--border-light);
  transition: all 0.2s ease;
}

.post-comm-icon:hover {
  border-color: var(--primary-purple);
  transform: scale(1.1);
}


/* === Global Chat === */
.global-chat-container {
  display: none;
  height: calc(100vh - 100px);
  flex-direction: column;
  padding: 24px;
  background: var(--bg-white);
  border-radius: 16px;
  box-shadow: var(--shadow-sm);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  border: 1px solid var(--border-light);
  border-radius: 12px;
  background: var(--bg-light);
  margin-bottom: 16px;
}

.chat-input-area {
  display: flex;
  gap: 12px;
}

.chat-bubble {
  max-width: 70%;
  padding: 10px 16px;
  border-radius: 16px;
  margin-bottom: 10px;
  width: fit-content;
  box-shadow: var(--shadow-sm);
}

.chat-bubble.mine {
  background: var(--gradient-primary);
  color: white;
  align-self: flex-end;
  margin-left: auto;
  border-bottom-right-radius: 4px;
}

.chat-bubble.others {
  background: var(--bg-white);
  color: var(--text-dark);
  border-bottom-left-radius: 4px;
}

.chat-user {
  font-size: 11px;
  font-weight: bold;
  margin-bottom: 4px;
  display: block;
  opacity: 0.9;
}

.chat-time {
  font-size: 10px;
  opacity: 0.7;
  margin-left: 6px;
}

/* === Community Content Layout === */
.community-content-wrapper {
  display: flex;
  gap: 20px;
  transition: all 0.3s ease;
}

#commPostsHere {
  flex: 1;
  transition: all 0.3s ease;
}

.community-chat-sidebar {
  width: 0;
  overflow: hidden;
  opacity: 0;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  background: var(--bg-white);
  border-left: 1px solid var(--border-light);
  border-radius: 16px;
  height: calc(100vh - 120px);
  position: sticky;
  top: 80px;
  box-shadow: var(--shadow-sm);
}

.community-chat-sidebar.active {
  width: 350px;
  opacity: 1;
  padding: 16px;
}

.comm-chat-header {
  font-weight: bold;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-light);
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: var(--text-dark);
}

.comm-chat-msgs {
  flex: 1;
  overflow-y: auto;
  background: var(--bg-light);
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 12px;
}

.comm-chat-input-area {
  display: flex;
  gap: 8px;
}

/* === Notifications === */
.notif-btn {
  position: relative;
  cursor: pointer;
}

.notif-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: var(--gradient-primary);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  box-shadow: var(--shadow-sm);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.notif-dropdown {
  position: absolute;
  top: 50px;
  right: 10px;
  width: 380px;
  max-height: 550px;
  background: var(--bg-white);
  border-radius: 16px;
  box-shadow: var(--shadow-xl);
  display: none;
  z-index: 1000;
  overflow: hidden;
  backdrop-filter: blur(10px);
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.notif-dropdown.active {
  display: block;
}

.notif-header {
  padding: 16px 18px;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: bold;
  background: var(--gradient-soft);
  color: var(--text-dark);
}

.notif-list {
  max-height: 450px;
  overflow-y: auto;
}

.notif-item {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border-light);
  cursor: pointer;
  transition: all 0.2s ease;
}

.notif-item:hover {
  background: var(--gradient-soft);
  padding-left: 24px;
}

.notif-item.unread {
  background: linear-gradient(135deg, #F3E8FF 0%, #EFF6FF 100%);
  border-left: 3px solid var(--primary-purple);
}

.notif-icon {
  display: inline-block;
  margin-right: 10px;
  font-size: 18px;
}

.notif-message {
  font-size: 13px;
  line-height: 1.5;
  color: var(--text-dark);
}

.notif-time {
  font-size: 11px;
  color: var(--text-light);
  margin-top: 6px;
}

.notif-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.notif-actions button {
  padding: 6px 14px;
  font-size: 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.accept-btn {
  background: var(--gradient-primary);
  color: white;
  box-shadow: var(--shadow-sm);
}

.accept-btn:hover {
  transform: scale(1.05);
  box-shadow: var(--shadow-md);
}

.reject-btn {
  background: var(--border-light);
  color: var(--text-gray);
}

.reject-btn:hover {
  background: #D1D5DB;
}

.notif-footer {
  padding: 12px 18px;
  border-top: 1px solid var(--border-light);
  text-align: center;
  background: var(--bg-light);
}

.clear-btn {
  background: none;
  border: none;
  color: var(--primary-purple);
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  transition: color 0.2s ease;
}

.clear-btn:hover {
  color: var(--primary-blue);
}

/* === Find Members Page === */
.find-members-page {
  display: none;
  padding: 32px;
  background: var(--bg-white);
  border-radius: 16px;
  max-width: 800px;
  margin: 24px auto;
  box-shadow: var(--shadow-md);
}

.find-members-page h2 {
  color: var(--text-dark);
  margin-top: 0;
}

.find-members-search {
  display: flex;
  gap: 12px;
  margin-bottom: 28px;
}

.find-members-search input {
  flex: 1;
  padding: 12px 18px;
  border: 1px solid var(--border-light);
  border-radius: 10px;
  font-size: 14px;
  transition: all 0.2s ease;
}

.find-members-search input:focus {
  outline: none;
  border-color: var(--primary-purple);
  box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
}

.find-members-search button {
  padding: 12px 24px;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s ease;
}

.find-members-search button:hover {
  transform: scale(1.02);
  box-shadow: var(--shadow-md);
}

.user-list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border: 1px solid var(--border-light);
  border-radius: 12px;
  margin-bottom: 10px;
  background: var(--bg-white);
  transition: all 0.2s ease;
}

.user-list-item:hover {
  background: var(--gradient-soft);
  transform: translateX(4px);
  box-shadow: var(--shadow-sm);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 14px;
}

.user-avatar-small {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--border-light);
  transition: all 0.2s ease;
}

.user-list-item:hover .user-avatar-small {
  border-color: var(--primary-purple);
}

.invite-btn {
  padding: 8px 20px;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s ease;
}

.invite-btn:hover {
  transform: scale(1.05);
  box-shadow: var(--shadow-md);
}

.refresh-btn {
  padding: 12px 24px;
  background: var(--gradient-accent);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  width: 100%;
  margin-top: 16px;
  font-weight: 600;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s ease;
}

.refresh-btn:hover {
  transform: scale(1.02);
  box-shadow: var(--shadow-md);
}

.refresh-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}


/* === Custom Modal === */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(8px);
    z-index: 2000; opacity: 0; transition: opacity 0.3s ease;
    display: flex; align-items: center; justify-content: center;
    visibility: hidden;
}
.modal-overlay.active { opacity: 1; visibility: visible; }

.modal-content {
    background: linear-gradient(135deg, #ffffff 0%, #f9f9f9 100%);
    width: 90%; max-width: 420px;
    padding: 30px; border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.8) inset;
    transform: scale(0.9) translateY(20px); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    text-align: center;
}
.modal-overlay.active .modal-content { transform: scale(1) translateY(0); }

.modal-title { font-size: 22px; font-weight: 700; margin-bottom: 12px; color: #333; }
.modal-desc { font-size: 15px; color: #666; margin-bottom: 24px; line-height: 1.5; }

.modal-input {
    width: 100%; padding: 14px 16px; font-size: 16px; border-radius: 12px;
    border: 2px solid #eee; background: #fff; outline: none;
    transition: all 0.2s; margin-bottom: 20px;
}
.modal-input:focus { border-color: #6c5ce7; box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1); }
.modal-input.shake { animation: shake 0.3s; border-color: #ff4757; }
@keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} 100%{transform:translateX(0)} }

.modal-actions { display: flex; gap: 12px; justify-content: center; }
.modal-btn {
    padding: 12px 24px; border-radius: 12px; border: none; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; flex: 1;
}
.modal-btn:active { transform: scale(0.96); }
.modal-btn.cancel { background: #f0f0f0; color: #555; }
.modal-btn.confirm {
    background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
    color: white; box-shadow: 0 6px 15px rgba(108, 92, 231, 0.3);
}
.modal-btn.confirm.danger { background: linear-gradient(135deg, #ff4757 0%, #ff6b81 100%); box-shadow: 0 6px 15px rgba(255, 71, 87, 0.3); }

/* Selection List */
.modal-list { max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 20px; border: 1px solid #eee; border-radius: 12px; }
.modal-list-item {
    padding: 12px 16px; border-bottom: 1px solid #f5f5f5; cursor: pointer;
    display: flex; align-items: center; transition: background 0.2s;
}
.modal-list-item:last-child { border-bottom: none; }
.modal-list-item:hover { background: #f8f9fa; }
.modal-list-item.selected { background: #f0f4ff; color: #6c5ce7; font-weight: 600; }

/* === Developer Tools === */
.dev-tools-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(31,41,55,0.7);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
}

.dev-tools-content {
  background: var(--bg-white);
  padding: 32px;
  border-radius: 16px;
  width: 600px;
  max-width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: var(--shadow-xl);
}

.dev-tools-search {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
}

.dev-tools-search input {
  flex: 1;
  padding: 12px 18px;
  border: 1px solid var(--border-light);
  border-radius: 10px;
  font-size: 14px;
}

.dev-tools-search button {
  padding: 12px 24px;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
}

.dev-community-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border: 1px solid var(--border-light);
  border-radius: 12px;
  margin-bottom: 12px;
  transition: all 0.2s ease;
}

.dev-community-item:hover {
  background: var(--gradient-soft);
  transform: translateX(4px);
}

.dev-community-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.dev-community-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--border-light);
}

.verify-toggle-btn {
  padding: 8px 20px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.verify-toggle-btn.verified {
  background: #DCFCE7;
  color: #16A34A;
}

.verify-toggle-btn.unverified {
  background: var(--gradient-primary);
  color: white;
}

/* === Verified Badge === */
.verified-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  background: #3B82F6;
  border-radius: 50%;
  color: white;
  font-size: 12px;
  margin-left: 6px;
  vertical-align: middle;
}

/* === Admin Badge Images === */
.admin-badge {
  width: 20px;
  height: 20px;
  margin-left: 6px;
  vertical-align: middle;
  object-fit: contain;
}

.dev-badge {
  width: 50px;
  height: 18px;
  margin-left: 6px;
  vertical-align: middle;
  object-fit: contain;
}

/* === Admin Tools Modal === */
.admin-tools-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(31,41,55,0.7);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
}

.admin-tools-content {
  background: var(--bg-white);
  padding: 0;
  border-radius: 16px;
  width: 900px;
  max-width: 95vw;
  height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-xl);
  overflow: hidden;
}

.admin-tools-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-light);
}

.admin-tools-tabs {
  display: flex;
  gap: 4px;
  padding: 0 24px;
  border-bottom: 1px solid var(--border-light);
}

.admin-tab {
  padding: 12px 20px;
  border: none;
  background: none;
  cursor: pointer;
  font-weight: 600;
  color: var(--text-gray);
  border-bottom: 3px solid transparent;
  transition: all 0.2s ease;
}

.admin-tab:hover {
  color: var(--primary-purple);
}

.admin-tab.active {
  color: var(--primary-purple);
  border-bottom-color: var(--primary-purple);
}

.admin-tools-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

/* Admin List */
.admin-list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border: 1px solid var(--border-light);
  border-radius: 12px;
  margin-bottom: 12px;
  transition: all 0.2s ease;
}

.admin-list-item:hover {
  background: var(--gradient-soft);
}

.admin-info {
  display: flex;
  align-items: center;
  gap: 14px;
}

.admin-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--border-light);
}

.admin-details h4 {
  margin: 0 0 4px 0;
  display: flex;
  align-items: center;
  gap: 6px;
}

.admin-details p {
  margin: 0;
  font-size: 13px;
  color: var(--text-gray);
}

.admin-actions {
  display: flex;
  gap: 8px;
}

/* Chat Sidebar */
.chat-sidebar-panel {
  position: fixed;
  top: 0;
  right: -400px;
  width: 400px;
  height: 100%;
  background: var(--bg-white);
  box-shadow: var(--shadow-xl);
  z-index: 4000;
  transition: right 0.3s ease;
  display: flex;
  flex-direction: column;
}

.chat-sidebar-panel.open {
  right: 0;
}

.chat-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-light);
  background: var(--gradient-primary);
  color: white;
}

.chat-panel-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  background: var(--bg-light);
}

.chat-panel-input {
  display: flex;
  gap: 8px;
  padding: 12px;
  border-top: 1px solid var(--border-light);
}

.chat-panel-input input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid var(--border-light);
  border-radius: 20px;
}

/* Room List */
.room-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 16px;
  border: 1px solid var(--border-light);
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.room-item:hover {
  background: var(--gradient-soft);
  transform: translateX(4px);
}

.create-room-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  margin-bottom: 20px;
}

</style>
</head>
<body>

<div class="navbar">
  <div style="display:flex;align-items:center;gap:10px">
    <button onclick="toggleSidebar()" style="background:none;color:white;font-size:24px;padding:0;cursor:pointer;border:none;">☰</button>
    <button onclick="goBack()" class="nav-back-btn" title="Go Back">⬅</button>
    <span>College Connect</span>
  </div>
  
  <div class="search-container" style="position:relative;">
    <input type="text" class="search-input" id="searchInput" placeholder="Search communities..." oninput="searchCommunities()">
    <div id="searchResults" class="search-results"></div>
  </div>
  
  <div style="display:flex;align-items:center;gap:10px">
    <div class="notif-btn" onclick="toggleNotifications()">
      <button style="background:white;color:black;font-weight:bold;padding:8px 16px;border-radius:6px;border:none;cursor:pointer">
        🔔 Messages
      </button>
      <span id="notifBadge" class="notif-badge" style="display:none">0</span>
    </div>
    <button onclick="openProfile(USER)" style="background:white;color:black;font-weight:bold">Profile</button>
    <button onclick="logout()" style="background:white;color:black">Logout</button>
  </div>
</div>

<!-- Notifications Dropdown -->
<div id="notifDropdown" class="notif-dropdown">
  <div class="notif-header">
    <span>Notifications</span>
  </div>
  <div id="notifList" class="notif-list"></div>
  <div class="notif-footer">
    <span class="small" style="color:#666"></span>
  </div>
</div>

<div class="container">
  <div class="sidebar">
    <button onclick="loadHomeFeed()" style="background:#ffe2d2;font-weight:bold;cursor:pointer;border:none;width:100%;text-align:left;padding:10px;border-radius:8px;">🏠 Home</button>
    <button onclick="loadGlobalChat()" style="background:none;font-weight:bold;cursor:pointer;border:none;width:100%;text-align:left;padding:10px;border-radius:8px;margin-top:4px;">💬 Live Chat</button>
    <button id="devToolsBtn" onclick="openDevTools()" style="display:none;background:none;font-weight:bold;cursor:pointer;border:none;width:100%;text-align:left;padding:10px;border-radius:8px;margin-top:4px;">🛠️ Developer Tools</button>
    <button id="adminToolsBtn" onclick="openAdminTools()" style="display:none;background:none;font-weight:bold;cursor:pointer;border:none;width:100%;text-align:left;padding:10px;border-radius:8px;margin-top:4px;">👑 Admin Tools</button>
    
    <h3 style="margin-top:20px;">Developer Communities</h3>
    <div id="developerGroups"></div>
    
    <h3 style="margin-top:20px;">Joined Communities</h3>
    <div id="joinedGroups"></div>
    
    <h3 style="margin-top:20px;">Created Communities</h3>
    <div id="createdGroups"></div>

    <h3 style="margin-top:20px;">Popular Communities</h3>
    <div id="popularGroups"></div>
    
    <p onclick="createGroup()" style="color:#ff4500;cursor:pointer;margin-top:16px;">+ Create community</p>
    <p onclick="openFindMembers()" style="color:#0079d3;cursor:pointer;margin-top:8px;">👥 Find Members</p>
  </div>

  <div class="main">
    <button class="createBtn" onclick="openPostModal()">+ Create Post</button>
    <h2 id="selTitle">Popular Posts</h2>
    <div id="postsHere"></div>
    
    <!-- Profile Page -->
    <div id="profilePage" class="profile-container">
      <div style="display:flex;align-items:center;gap:20px">
        <img id="pAvatar" src="" class="avatar-large" onerror="this.src='https://via.placeholder.com/100'">
        <div>
          <h2 id="pName"></h2>
          <input type="file" id="pAvatarInput" style="display:none" accept="image/*">
          <button id="pEditPicBtn" onclick="document.getElementById('pAvatarInput').click()" class="small" style="margin-top:5px">Change Pic</button>
        </div>
      </div>
      <div style="margin-top:20px">
        <label><b>About:</b></label>
        <textarea id="pAbout" rows="3"></textarea>
      </div>
      <div style="margin-top:10px">
        <label><b>Hobbies:</b></label>
        <input id="pHobbies">
      </div>
      <div style="margin-top:20px">
        <button id="pSaveBtn" class="createBtn" onclick="saveProfile()">Save Profile</button>
        <button onclick="closeProfile()">Close</button>
      </div>
    </div>
    
    <!-- Global Chat Page -->
    <div id="globalChatPage" class="global-chat-container">
      <h2 style="margin-bottom:10px;">Global Lounge</h2>
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input-area">
        <textarea id="chatInput" rows="2" placeholder="Type a message..." style="flex:1;"></textarea>
        <input type="file" id="globalChatImage" accept="image/*" style="display:none;">
        <button onclick="document.getElementById('globalChatImage').click()" style="padding:8px 12px;">📷</button>
        <button class="createBtn" onclick="sendGlobalMessage()" style="width:100px;">Send</button>
      </div>
    </div>

    <!-- Find Members Page -->
    <div id="findMembersPage" class="find-members-page">
      <h2>Find Members</h2>
      <p style="color:#666;margin-bottom:20px;">Search for users and send them community invitations</p>
      <div class="find-members-search">
        <input type="text" id="findMembersSearch" placeholder="Search username...">
        <button onclick="searchUsersToInvite()">Search</button>
      </div>
      <div id="userSearchResults"></div>
      
      <h3 style="margin-top:30px;">Suggested Users <span id="randomUserCount" style="font-size:14px;color:#666;font-weight:normal;"></span></h3>
      <div id="randomUsersList"></div>
      <button class="refresh-btn" id="refreshUsersBtn" onclick="refreshRandomUsers()">🔄 Refresh</button>
      <p id="cooldownTimer" style="text-align:center;color:#999;font-size:12px;margin-top:8px;display:none;"></p>
    </div>

    <!-- Developer Tools Modal -->
    <div id="devToolsModal" class="dev-tools-modal">
      <div class="dev-tools-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
          <h2 style="margin:0;">Developer Tools - Community Verification</h2>
          <button onclick="closeDevTools()" style="background:none;border:none;font-size:24px;cursor:pointer;">✖</button>
        </div>
        <p style="color:#666;margin-bottom:20px;">Search for communities and toggle their verification status</p>
        <div class="dev-tools-search">
          <input type="text" id="devToolsSearch" placeholder="Search community name...">
          <button onclick="searchCommunitiesForVerification()">Search</button>
        </div>
        <div id="devToolsResults"></div>
      </div>
    </div>

    <!-- Admin Tools Modal -->
    <div id="adminToolsModal" class="admin-tools-modal">
      <div class="admin-tools-content">
        <div class="admin-tools-header">
          <h2 style="margin:0;">👑 Admin Tools</h2>
          <button onclick="closeAdminTools()" style="background:none;border:none;font-size:24px;cursor:pointer;">✖</button>
        </div>
        <div class="admin-tools-tabs">
          <button class="admin-tab active" onclick="switchAdminTab('admins', event)">Verified Admins</button>
          <button class="admin-tab" onclick="switchAdminTab('conversations', event)">My Conversations</button>
          <button class="admin-tab" onclick="switchAdminTab('rooms', event)" id="roomsTab">Private Rooms</button>
        </div>
        <div class="admin-tools-body">
          <!-- Tab Content -->
          <div id="adminTabAdmins"></div>
          <div id="adminTabConversations" style="display:none;"></div>
          <div id="adminTabRooms" style="display:none;"></div>
        </div>
      </div>
    </div>

    <!-- DM Chat Panel (Slide-in) -->
    <div id="dmChatPanel" class="chat-sidebar-panel">
      <div class="chat-panel-header">
        <div>
          <strong id="dmChatPartner">Chat</strong>
        </div>
        <button onclick="closeDMChat()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">✖</button>
      </div>
      <div id="dmChatMessages" class="chat-panel-messages"></div>
      <div class="chat-panel-input">
        <input type="file" id="dmImageInput" accept="image/*" style="display:none;">
        <button onclick="document.getElementById('dmImageInput').click()" style="padding:8px;background:#666;color:white;border:none;border-radius:8px;cursor:pointer;">📷</button>
        <input type="text" id="dmChatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendDM()">
        <button onclick="sendDM()" style="padding:8px 16px;background:var(--gradient-primary);color:white;border:none;border-radius:8px;cursor:pointer;">Send</button>
      </div>
    </div>

    <!-- Room Chat Modal -->
    <div id="roomChatModal" class="admin-tools-modal">
      <div class="admin-tools-content" style="height:85vh;">
        <div class="admin-tools-header">
          <div>
            <h2 id="roomChatName" style="margin:0;">Room</h2>
            <span id="roomMemberCount" style="font-size:12px;color:#666;"></span>
          </div>
          <div style="display:flex;gap:10px;">
            <button onclick="openInviteModal()" style="padding:8px 16px;background:var(--gradient-primary);color:white;border:none;border-radius:8px;cursor:pointer;">+ Invite</button>
            <button onclick="closeRoomChat()" style="background:none;border:none;font-size:24px;cursor:pointer;">✖</button>
          </div>
        </div>
        <div id="roomChatMessages" class="chat-panel-messages" style="flex:1;"></div>
        <div class="chat-panel-input">
          <input type="file" id="roomImageInput" accept="image/*" style="display:none;">
          <button onclick="document.getElementById('roomImageInput').click()" style="padding:8px;background:#666;color:white;border:none;border-radius:8px;cursor:pointer;">📷</button>
          <input type="text" id="roomChatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendRoomMessage()" style="flex:1;">
          <button onclick="sendRoomMessage()" style="padding:8px 16px;background:var(--gradient-primary);color:white;border:none;border-radius:8px;cursor:pointer;">Send</button>
        </div>
      </div>
    </div>

    <!-- Community Page -->

    <div id="communityPage" class="community-page">
      <div class="community-header">
        <div class="community-banner"></div>
        <div class="community-info">
          <img id="commIcon" class="community-icon" src="https://via.placeholder.com/80" onerror="this.src='https://via.placeholder.com/80'">
          <div class="community-details">
            <h1 id="commName" class="community-name"></h1>
            <div id="commStats" class="community-stats"></div>
            <div id="commDesc" style="margin-top:8px;color:#1F2937;"></div>
          </div>
          <div class="community-actions">
            <button id="joinBtn" class="join-btn" onclick="toggleJoin()">Join</button>
            <button id="commEditBtn" style="display:none;" onclick="openCommEdit()">Edit Community</button>
            <button id="membersBtn" class="join-btn" onclick="toggleMembersList()" style="background:#666;">Members</button>
          </div>
        </div>
      </div>
      
      <!-- Members List -->
      <div id="membersList" class="members-list" style="display:none; margin:0 20px;">
        <h3>Members</h3>
        <div id="membersContainer"></div>
      </div>
      
      <div style="padding:0 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <button class="createBtn" onclick="openPostModal()">+ Create Post</button>
            <button id="liveChatBtn" class="createBtn" onclick="toggleCommunityChat()">💬 Live Chat</button>
        </div>
        
        <div class="community-content-wrapper">
            <!-- Left: Posts -->
            <div id="commPostsHere"></div>

            <!-- Right: Live Chat Sidebar -->
            <div id="communityChatSidebar" class="community-chat-sidebar">
                <div class="comm-chat-header">
                    <span id="commChatTitleSidebar">Live Chat</span>
                    <button onclick="toggleCommunityChat()" style="background:none;border:none;cursor:pointer;">✖</button>
                </div>
                <div id="commChatMessages" class="comm-chat-msgs"></div>
                <div class="comm-chat-input-area">
                    <input type="file" id="commChatImage" accept="image/*" style="display:none;">
                    <button onclick="document.getElementById('commChatImage').click()" style="padding:8px; background:#666; color:white; border:none; border-radius:4px; cursor:pointer;">📷</button>
                    <input type="text" id="commChatInput" placeholder="Message..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
                    <button onclick="sendCommunityMessage()" style="padding:8px 12px; background:#ff4500; color:white; border:none; border-radius:4px; cursor:pointer;">Send</button>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Community Edit Modal -->
<div class="modalBg" id="commEditModal" aria-hidden="true">
  <div class="modal">
    <h3>Edit Community</h3>
    <label>Description:</label>
    <textarea id="commDescInput" rows="3"></textarea>
    <label style="margin-top:10px;">Community Icon:</label>
    <input type="file" id="commIconInput" accept="image/*">
    <div style="margin-top:10px">
      <button class="createBtn" onclick="saveCommEdit()">Save</button>
      <button onclick="closeCommEdit()">Cancel</button>
    </div>
  </div>
</div>

<!-- Post Modal -->
<div class="modalBg" id="postModal" aria-hidden="true">
  <div class="modal">
    <h3>Create Post in <span id="mComm"></span></h3>
    <input id="pTitle" placeholder="Title">
    <textarea id="pText" placeholder="Write..." rows="5"></textarea>
    <input type="file" id="imgInput" accept="image/*">
    <div style="margin-top:10px">
      <button class="createBtn" onclick="makePost()">Post</button>
      <button onclick="closePostModal()">Cancel</button>
    </div>
    <div class="small" id="postErr"></div>
  </div>
</div>

<!-- Reply Modal -->
<div class="modalBg" id="replyModal" aria-hidden="true">
  <div class="modal">
    <h3>Reply</h3>
    <textarea id="replyText" rows="4"></textarea>
    <div style="margin-top:10px">
      <button class="createBtn" onclick="sendReply()">Reply</button>
      <button onclick="closeReply()">Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Post Modal -->
<div class="modalBg" id="editModal" aria-hidden="true">
  <div class="modal">
    <h3>Edit Post</h3>
    <input id="eTitle" placeholder="Title">
    <textarea id="eText" placeholder="Content" rows="5"></textarea>
    <div style="margin-top:10px">
      <button class="createBtn" onclick="submitEdit()">Save</button>
      <button onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
    </div>
  </div>
</div>

<!-- Edit Comment Modal -->
<div class="modalBg" id="editCommentModal" aria-hidden="true">
  <div class="modal">
    <h3>Edit Comment</h3>
    <textarea id="ecText" rows="4"></textarea>
    <div style="margin-top:10px">
      <button class="createBtn" onclick="submitEditComment()">Save</button>
      <button onclick="closeEditComment()">Cancel</button>
    </div>
  </div>
</div>

<script>
const API = (location.hostname === "localhost" || location.hostname === "127.0.0.1") && location.port === "5503" 
  ? "" 
  : "http://127.0.0.1:5503";
let USER = localStorage.getItem("username");           // <-- MUST be "username"
if(!USER) location.href = "login.html";
// document.getElementById("usr").innerText = "logged in: " + USER; // Removed as per request

let SELECTED = null, REPLY_POST = null, PARENT = null;
let POSTS_CACHE = {};
let COMMUNITY_INFO = {}; 
let TOP_COMMUNITIES = [];

// Navigation Stack
let NAV_STACK = [];
let IS_NAVIGATING_BACK = false;

function pushNavState(state) {
    if (IS_NAVIGATING_BACK) return;
    // Don't push if just refreshing same view
    const last = NAV_STACK[NAV_STACK.length - 1];
    if (last && last.view === state.view && last.data === state.data) return;
    
    NAV_STACK.push(state);
    // Limit stack size
    if (NAV_STACK.length > 50) NAV_STACK.shift();
}

function goBack() {
    if (NAV_STACK.length <= 1) {
        // At home or empty, ensure home
         if(NAV_STACK.length === 1 && NAV_STACK[0].view === 'home') return;
         loadHomeFeed(); 
         return;
    }

    NAV_STACK.pop(); // Remove current
    const prev = NAV_STACK[NAV_STACK.length - 1]; // Get previous

    IS_NAVIGATING_BACK = true;
    
    if (!prev || prev.view === 'home') {
        loadHomeFeed();
    } else if (prev.view === 'community') {
        openComm(prev.data);
    } else if (prev.view === 'profile') {
        openProfile(prev.data);
    } else if (prev.view === 'chat') {
        loadGlobalChat();
    } else if (prev.view === 'members') {
        openFindMembers();
    }
    
    IS_NAVIGATING_BACK = false;
}

// Load groups (communities)
async function loadGroups(){

  try{
    const res = await fetch(API + `/api/groups?username=${USER}`);
    const groups = await res.json();
    
    // Define containers
    const devContainer = document.getElementById("developerGroups");
    const joinedContainer = document.getElementById("joinedGroups");
    const createdContainer = document.getElementById("createdGroups");
    
    // Populate Global Cache
    ALL_COMMUNITIES = groups;
    
    // Check if user is in r/Dev and show Developer Tools button
    const devComm = groups.find(c => c.name === 'Dev');
    const devToolsBtn = document.getElementById('devToolsBtn');
    if (devComm && devComm.members.includes(USER)) {
      devToolsBtn.style.display = 'block';
    } else {
      devToolsBtn.style.display = 'none';
    }
    
    // Check if user is admin of any verified community and show Admin Tools button
    const verifiedCommunities = groups.filter(c => c.isVerified);
    const isVerifiedAdmin = verifiedCommunities.some(c => c.creator === USER);
    const adminToolsBtn = document.getElementById('adminToolsBtn');
    if (isVerifiedAdmin) {
      adminToolsBtn.style.display = 'block';
    } else {
      adminToolsBtn.style.display = 'none';
    }
    
    // Developer communities (always shown)
    const devCommunities = ['Dev', 'Suggestions'];
    devContainer.innerHTML = "";
    devCommunities.forEach(name => {
      const comm = groups.find(c => c.name === name);
      const p = document.createElement("p");
      p.innerHTML = "r/" + name + (comm && comm.isVerified ? getVerifiedBadge() : '');
      p.onclick = () => openComm(name);
      p.style.cursor = "pointer";
      p.style.padding = "12px 16px";
      p.style.margin = "4px 0";
      p.style.borderRadius = "10px";
      p.style.transition = "all 0.2s ease";
      p.onmouseover = () => {
        p.style.background = "var(--gradient-soft)";
        p.style.transform = "translateX(4px)";
      };
      p.onmouseout = () => {
        p.style.background = "transparent";
        p.style.transform = "translateX(0)";
      };
      devContainer.appendChild(p);
    });

    // Populate joined communities
    
    // Separate communities into joined and created (remove duplicates using Set)
    // Exclude Dev and Suggestions from these sections
    const joinedSet = new Set();
    const createdSet = new Set();
    const joinedCommunities = [];
    const createdCommunities = [];
    
    groups.forEach(g => {
      // Skip developer communities
      if (devCommunities.includes(g.name)) return;
      
      if(g.creator === USER && !createdSet.has(g.name)){
        createdSet.add(g.name);
        createdCommunities.push(g);
      } else if(g.members && g.members.includes(USER) && !joinedSet.has(g.name) && g.creator !== USER){
        joinedSet.add(g.name);
        joinedCommunities.push(g);
      }
    });
    
    // Clear containers
    joinedContainer.innerHTML = "";
    createdContainer.innerHTML = "";
    
    // Populate joined communities
    if(joinedCommunities.length === 0){
      joinedContainer.innerHTML = "<p class='small' style='color:#999;'>No joined communities</p>";
    } else {
      joinedCommunities.forEach(g => {
        const div = document.createElement("div");
        div.style.display = "flex";
        div.style.justifyContent = "space-between";
        div.style.alignItems = "center";
        div.style.marginBottom = "8px";
        
        const p = document.createElement("span");
        p.style.cursor = "pointer";
        p.innerHTML = "r/" + g.name + (g.isVerified ? getVerifiedBadge() : '');
        p.onclick = () => openComm(g.name);
        
        div.appendChild(p);
        joinedContainer.appendChild(div);
      });
    }
    
    // Populate created communities
    if(createdCommunities.length === 0){
      createdContainer.innerHTML = "<p class='small' style='color:#999;'>No created communities</p>";
    } else {
      createdCommunities.forEach(g => {
        const div = document.createElement("div");
        div.style.display = "flex";
        div.style.justifyContent = "space-between";
        div.style.alignItems = "center";
        div.style.marginBottom = "8px";
        
        const p = document.createElement("span");
        p.style.cursor = "pointer";
        p.innerHTML = "r/" + g.name + (g.isVerified ? getVerifiedBadge() : '');
        p.onclick = () => openComm(g.name);
        
        div.appendChild(p);
        
        // Add menu for creator
        const menuBtn = document.createElement("span");
        menuBtn.innerText = "..";
        menuBtn.className = "comm-menu-btn";
        menuBtn.onclick = (e) => toggleCommMenu(e, g.name);
        
        const menu = document.createElement("div");
        menu.id = "comm_menu_" + g.name;
        menu.className = "comm-menu";
        menu.innerHTML = `<div onclick="deleteGroup('${g.name}')">Delete</div>`;
        
        div.appendChild(menuBtn);
        div.appendChild(menu);
        
        div.appendChild(menu);
        
        createdContainer.appendChild(div);
      });
    }

    // Populate Popular Communities (remove duplicates)
    const popContainer = document.getElementById("popularGroups");
    popContainer.innerHTML = "";
    
    // Sort by member count (descending) and remove duplicates
    const uniqueGroups = [];
    const seenNames = new Set();
    
    groups.forEach(g => {
      // Exclude developer communities
      if(devCommunities.includes(g.name)) return;
      
      if (!seenNames.has(g.name)) {
        seenNames.add(g.name);
        uniqueGroups.push(g);
      }
    });
    
    const sorted = [...uniqueGroups].sort((a,b) => (b.members ? b.members.length : 0) - (a.members ? a.members.length : 0));
    TOP_COMMUNITIES = sorted.slice(0, 5);
    
    if(TOP_COMMUNITIES.length === 0){
       popContainer.innerHTML = "<p class='small' style='color:#999;'>No communities found</p>";
    } else {
       TOP_COMMUNITIES.forEach(g => {
          const div = document.createElement("div");
          div.style.display = "flex";
          div.style.alignItems = "center";
          div.style.marginBottom = "8px";
          
          const p = document.createElement("span");
          p.style.cursor = "pointer";
          p.innerHTML = "r/" + g.name + (g.isVerified ? getVerifiedBadge() : '');
          p.onclick = () => openComm(g.name);
          
          div.appendChild(p);
          popContainer.appendChild(div);
       });
    }
    
  }catch(err){
    console.error("Groups load error", err);
  } finally {
    // Load home feed if no community selected
    if(!SELECTED) loadHomeFeed();
  }
}
loadGroups();

function openComm(name){
  pushNavState({ view: 'community', data: name });
  SELECTED = name;
  document.getElementById("mComm").innerText = name;
  localStorage.setItem("community", name);
  
  // Hide other views
  document.getElementById("postsHere").style.display = "none";
  document.getElementById("selTitle").style.display = "none";
  document.querySelector(".createBtn").style.display = "none";
  document.getElementById("profilePage").style.display = "none";
  document.getElementById("globalChatPage").style.display = "none";
  document.getElementById("findMembersPage").style.display = "none";
  document.getElementById("findMembersPage").style.display = "none";
  
  // Show community page
  document.getElementById("communityPage").style.display = "block";
  
  // Load community data
  loadCommunityPage(name);
}

let CURRENT_COMMUNITY = null;

async function loadCommunityPage(name){
  try{
    const res = await fetch(API + "/api/groups");
    const groups = await res.json();
    const community = groups.find(g => g.name === name);
    
    if(!community) return;
    
    CURRENT_COMMUNITY = community;
    
    // Set community info
    document.getElementById("commName").innerHTML = "r/" + name + (community.isVerified ? getVerifiedBadge() : '');
    document.getElementById("commStats").innerText = `${community.members ? community.members.length : 0} members`;
    document.getElementById("commDesc").innerText = community.description || "No description yet";
    
    if(community.icon){
      document.getElementById("commIcon").src = API + community.icon;
    } else {
      document.getElementById("commIcon").src = "https://via.placeholder.com/80";
    }
    
    // Update join button - hide for creator
    const isCreator = community.creator === USER;
    const joined = community.members && community.members.includes(USER);
    const joinBtn = document.getElementById("joinBtn");
    
    if(isCreator){
      // Hide join button for creator
      joinBtn.style.display = "none";
    } else {
      joinBtn.style.display = "inline-block";
      if(joined){
        joinBtn.innerText = "Leave Group";
        joinBtn.classList.add("joined");
      } else {
        joinBtn.innerText = "Join";
        joinBtn.classList.remove("joined");
      }
    }
    
    // Show edit button if creator
    if(isCreator){
      document.getElementById("commEditBtn").style.display = "inline-block";

      // Close/Open Community Button
      let toggleBtn = document.getElementById("commToggleBtn");
      if(!toggleBtn) {
         toggleBtn = document.createElement("button");
         toggleBtn.id = "commToggleBtn";
         toggleBtn.className = "join-btn"; // reuse style
         toggleBtn.style.marginLeft = "10px";
         toggleBtn.style.backgroundColor = "#ff4500"; 
         document.querySelector(".community-actions").appendChild(toggleBtn);
      }
      
      toggleBtn.innerText = community.isClosed ? "Open Community" : "Close Community";
      toggleBtn.onclick = () => toggleCommunityStatus(community.name);

    } else {
      document.getElementById("commEditBtn").style.display = "none";
      const toggleBtn = document.getElementById("commToggleBtn");
      if(toggleBtn) toggleBtn.remove();
      
      // Hide join button if closed and not a member
      if (community.isClosed && !joined) {
          joinBtn.style.display = "none";
      }
    }
    
    // Populate members list
    populateMembersList(community);
    
    // Load posts for this community
    loadCommunityPosts(name);
  }catch(e){ console.error(e); }
}

async function loadCommunityPosts(name){
  try{
    const res = await fetch(API + "/api/post/list", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ community: name })
    });
    const posts = await res.json();
    const container = document.getElementById("commPostsHere");
    container.innerHTML = "";
    
    if(!posts || posts.length === 0){
      container.innerHTML = "<p class='small'>No posts in this community yet.</p>";
      return;
    }
    
    posts.forEach(x=>{
      POSTS_CACHE[x._id] = x;
      const d = document.createElement("div");
      d.className = "postCard";
      d.setAttribute("data-post-id", x._id);
      d.innerHTML = renderPost(x);
      container.appendChild(d);
    });
  }catch(err){
    console.error("Load community posts error", err);
  }
}

async function toggleJoin(){
  if(!CURRENT_COMMUNITY) return;
  
  const joined = CURRENT_COMMUNITY.members && CURRENT_COMMUNITY.members.includes(USER);
  const endpoint = joined ? "/api/community/leave" : "/api/community/join";
  
  try{
    const res = await fetch(API + endpoint, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ name: CURRENT_COMMUNITY.name, username: USER })
    });
    const d = await res.json();
    if(d.success){
      loadCommunityPage(CURRENT_COMMUNITY.name); // Reload
      showToast(joined ? "Left r/" + CURRENT_COMMUNITY.name : "Joined r/" + CURRENT_COMMUNITY.name, 'success');
    } else {
      showToast(d.msg || "Action failed", 'error');
    }
  }catch(e){ console.error(e); }
}

function openCommEdit(){
  if(!CURRENT_COMMUNITY) return;
  document.getElementById("commDescInput").value = CURRENT_COMMUNITY.description || "";
  document.getElementById("commEditModal").style.display = "flex";
}

function isMember(commName){
  if(!commName) return false;
  const c = ALL_COMMUNITIES.find(g => g.name === commName);
  if(!c) return false;
  // Creator is always a member
  if(c.creator === USER) return true;
  return c.members && c.members.includes(USER);
}

function closeCommEdit(){
  document.getElementById("commEditModal").style.display = "none";
}

async function saveCommEdit(){
  if(!CURRENT_COMMUNITY) return;
  
  const desc = document.getElementById("commDescInput").value;
  const file = document.getElementById("commIconInput").files[0];
  
  const fd = new FormData();
  fd.append("name", CURRENT_COMMUNITY.name);
  fd.append("username", USER);
  fd.append("description", desc);
  if(file) fd.append("icon", file);
  
  try{
    const res = await fetch(API + "/api/community/update", { method:"POST", body: fd });
    const d = await res.json();
    if(d.success){
      closeCommEdit();
      loadCommunityPage(CURRENT_COMMUNITY.name); // Reload
    }
  }catch(e){ console.error(e); }
}

function populateMembersList(community){
  const container = document.getElementById("membersContainer");
  container.innerHTML = "";
  
  if(!community.members || community.members.length === 0){
    container.innerHTML = "<p class='small'>No members yet</p>";
    return;
  }
  
  const isCurrentUserAdmin = (community.creator === USER);
  const isCurrentUserSubadmin = community.subadmins && community.subadmins.includes(USER);
  const canModerate = isCurrentUserAdmin || isCurrentUserSubadmin;
  
  community.members.forEach(member => {
    const div = document.createElement("div");
    div.className = "member-item";
    
    const isAdmin = (member === community.creator);
    const isSubadmin = community.subadmins && community.subadmins.includes(member);
    
    let roleClass = "";
    let roleText = "Member";
    if (isAdmin) {
      roleClass = "admin";
      roleText = "Admin";
    } else if (isSubadmin) {
      roleClass = "subadmin";
      roleText = "Subadmin";
    }
    
    // Build admin menu options
    let menuOptions = `<div onclick="openProfile('${member}')">View Profile</div>`;
    
    if (canModerate && member !== USER && !isAdmin) {
      // Admin-only options
      if (isCurrentUserAdmin) {
        if (isSubadmin) {
          menuOptions += `<div onclick="demoteSubadmin('${community.name}', '${member}')">Demote Subadmin</div>`;
        } else if (!community.subadmins || community.subadmins.length < 2) {
          menuOptions += `<div onclick="promoteSubadmin('${community.name}', '${member}')">Promote to Subadmin</div>`;
        }
      }
      
      // Admin or Subadmin can kick/ban
      menuOptions += `<div onclick="kickMember('${community.name}', '${member}')">Kick from Community</div>`;
      menuOptions += `<div onclick="banUser('${community.name}', '${member}')">Ban from Community</div>`;
    }
    
    div.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px;">
        <span class="member-name">${escapeHtml(member)}</span>
        <span class="cmt-menu-btn" onclick="toggleMemberMenu(event, '${member}')" style="font-size:14px;">..</span>
        <div id="member_menu_${member}" class="cmt-menu">
          ${menuOptions}
        </div>
      </div>
      <span class="member-role ${roleClass}">${roleText}</span>
    `;
    
    container.appendChild(div);
  });
  
  // Add Banned Users Section
  if(community.bannedUsers && community.bannedUsers.length > 0) {
    const bannedHeader = document.createElement("div");
    bannedHeader.style.marginTop = "20px";
    bannedHeader.style.paddingTop = "20px";
    bannedHeader.style.borderTop = "1px solid #ddd";
    bannedHeader.innerHTML = "<h4 style='margin:0 0 10px 0; color:#d32f2f;'>🚫 Banned Users</h4>";
    container.appendChild(bannedHeader);
    
    community.bannedUsers.forEach(ban => {
      const div = document.createElement("div");
      div.className = "member-item";
      div.style.background = "#fff5f5";
      
      const banDate = new Date(ban.bannedAt).toLocaleDateString();
      
      // Only admin can unban
      let menuOptions = `<div onclick="openProfile('${ban.username}')">View Profile</div>`;
      if (isCurrentUserAdmin) {
        menuOptions += `<div onclick="unbanUser('${community.name}', '${ban.username}')">Unban User</div>`;
      }
      
      div.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px;">
          <span class="member-name">${escapeHtml(ban.username)}</span>
          <span class="cmt-menu-btn" onclick="toggleMemberMenu(event, 'banned_${ban.username}')" style="font-size:14px;">..</span>
          <div id="member_menu_banned_${ban.username}" class="cmt-menu">
            ${menuOptions}
          </div>
        </div>
        <div style="font-size:11px; color:#666;">
          Banned by ${escapeHtml(ban.bannedBy)} on ${banDate}
        </div>
      `;
      
      container.appendChild(div);
    });
  }
}

function toggleMemberMenu(e, username){
  e.stopPropagation();
  // Close all menus
  document.querySelectorAll(".cmt-menu").forEach(el => el.style.display = "none");
  document.querySelectorAll(".comm-menu").forEach(el => el.style.display = "none");
  
  const menu = document.getElementById("member_menu_" + username);
  if(menu){
    menu.style.display = "block";
  }
}

function toggleMembersList(){
  const membersList = document.getElementById("membersList");
  if(membersList.style.display === "none"){
    membersList.style.display = "block";
  } else {
    membersList.style.display = "none";
  }
}


async function toggleJoinFromPost(communityName) {
  try {
    const res = await fetch(API + "/api/groups");
    const groups = await res.json();
    const community = groups.find(g => g.name === communityName);
    if (!community) return;

    const isMember = community.members && community.members.includes(USER);
    const endpoint = isMember ? "/api/community/leave" : "/api/community/join";

    const res2 = await fetch(API + endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: communityName, username: USER })
    });
    const data = await res2.json();
    
    if (data.success) {
      // Refresh groups to update UI state
      await loadGroups();
      
      // Refresh posts to update button state
      if (SELECTED) loadPosts();
      else loadHomeFeed();
      // Refresh posts to update button state
      if (SELECTED) loadPosts();
      else loadHomeFeed();
      showToast(isMember(community) ? "Left r/" + community : "Joined r/" + community, 'success');
    } else {
      showToast(data.msg || "Action failed", 'error');
    }

  } catch (err) {
    console.error("Toggle join error", err);
  }
}

function renderPost(x) {
  const commInfo = COMMUNITY_INFO[x.community] || {};
  const commIcon = commInfo.icon ? API + commInfo.icon : "https://via.placeholder.com/30";
  
  const isCreator = commInfo.creator === USER;
  const isMember = commInfo.members && commInfo.members.includes(USER);
  
  // Decide what to show for Join button
  let joinBtnHtml = "";
  if (!isCreator && x.author !== USER) {
    if (isMember) {
        joinBtnHtml = `<button class="post-join-btn joined" onclick="toggleJoinFromPost('${x.community}')">Leave Group</button>`;
    } else {
        joinBtnHtml = `<button class="post-join-btn" onclick="toggleJoinFromPost('${x.community}')">Join</button>`;
    }
  }

  return `
    <div class="post-header">
        <div style="display:flex;align-items:center;gap:8px">
            <img src="${commIcon}" class="post-comm-icon" onclick="openComm('${x.community}')">
            <span class="post-comm-link" onclick="openComm('${x.community}')">r/${x.community}${commInfo.isVerified ? getVerifiedBadge() : ''}</span>
            <span class="post-dot">•</span>
            <span class="post-user">Posted by ${escapeHtml(x.author)}</span>
            <span class="post-time"></span>
        </div>
        ${joinBtnHtml}
    </div>

    <div class="postTitle">${escapeHtml(x.title)}</div>
    ${x.image ? `<div class="postImg-container"><img class="postImg" src="${API + x.image}" alt="post image"></div>` : ""}
    <p>${escapeHtml(x.content || "")}</p>
    
    <div class="post-actions">
        <div style="display:flex;align-items:center;background:#f0f0f0;border-radius:20px;overflow:hidden">
             <button class="voteBtn up ${x.upvotes && x.upvotes.includes(USER) ? 'active' : ''}" onclick="vote('${x._id}', 'up')">⬆️</button>
             <span class="vote-count-up" style="font-weight:bold;padding:0 4px; color:#ff4500">${x.upvotes ? x.upvotes.length : 0}</span>
             <button class="voteBtn down ${x.downvotes && x.downvotes.includes(USER) ? 'active' : ''}" onclick="vote('${x._id}', 'down')">⬇️</button>
             <span class="vote-count-down" style="font-weight:bold;padding:0 4px; color:#7193ff">${x.downvotes ? x.downvotes.length : 0}</span>
        </div>
        
        <button class="action-btn" onclick="viewComments('${x._id}')">
            <span>💬</span> Comments
        </button>
        
        ${x.author === USER ? `
            <button class="action-btn" onclick="openEditModal('${x._id}')">
                <span>✎</span> Edit
            </button>
            <button class="action-btn" onclick="delPost('${x._id}')">
                <span>🗑️</span> Delete
            </button>
        ` : ""}
    </div>
    
    <div id="cmt_${x._id}"></div>
  `;
}

async function loadHomeFeed(){
  console.log("loadHomeFeed called");
  if(!IS_NAVIGATING_BACK) NAV_STACK = [{ view: 'home' }]; // Reset stack on explicit Home click
  SELECTED = null;
  localStorage.removeItem("community"); // Clear selection
  
  // UI Updates
  document.getElementById("selTitle").style.display = "block";
  document.getElementById("selTitle").innerText = "Popular Posts";
  document.getElementById("postsHere").style.display = "block";
  document.querySelector(".createBtn").style.display = "none";
  
  document.getElementById("communityPage").style.display = "none";
  document.getElementById("profilePage").style.display = "none";

  try {
     console.log("TOP_COMMUNITIES:", TOP_COMMUNITIES);
     
     // Always include r/Dev and r/Suggestions at the top
     const defaultCommunities = ['Dev', 'Suggestions'];
     const popularCommunities = (TOP_COMMUNITIES || []).map(c => c.name).filter(name => 
       !defaultCommunities.includes(name)
     );
     
     // Combine: default communities first, then popular ones
     const communities = [...defaultCommunities, ...popularCommunities];
     console.log("Fetching posts for:", communities);
     
     const res = await fetch(API + "/api/post/list", {
       method: "POST",
       headers: { "Content-Type": "application/json" },
       body: JSON.stringify({ communities })
     });
     const posts = await res.json();
     console.log("Posts received:", posts);
     
     const container = document.getElementById("postsHere");
     container.innerHTML = "";
     
     if(!posts || posts.length === 0){
       container.innerHTML = "<p class='small'>No popular posts available yet.</p>";
       return;
     }
     
     // Sort posts: r/Dev and r/Suggestions first, then by date
     const sortedPosts = posts.sort((a, b) => {
       const aIsDefault = defaultCommunities.includes(a.community);
       const bIsDefault = defaultCommunities.includes(b.community);
       
       if (aIsDefault && !bIsDefault) return -1;
       if (!aIsDefault && bIsDefault) return 1;
       
       // Both are default or both are not, sort by date
       return new Date(b.createdAt) - new Date(a.createdAt);
     });
     
     sortedPosts.forEach(x => {
        POSTS_CACHE[x._id] = x;
        const d = document.createElement("div");
        d.className = "postCard";
        d.setAttribute("data-post-id", x._id);
        d.innerHTML = renderPost(x);
        container.appendChild(d);
     });
     
  } catch(err) {
    console.error("Home feed error", err);
    document.getElementById("postsHere").innerHTML = `<p style="color:red">Error loading posts: ${err.message}. Check console.</p>`;
  }
}

/* Load posts */
async function loadPosts(){
  try{
    const res = await fetch(API + "/api/post/list", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ community: SELECTED })
    });
    const posts = await res.json();
    const container = document.getElementById("postsHere");
    container.innerHTML = "";
    if(!posts || posts.length === 0){
      container.innerHTML = "<p class='small'>No posts in this community yet.</p>";
      return;
    }
    posts.forEach(x=>{
      POSTS_CACHE[x._id] = x;
      const d = document.createElement("div");
      d.className = "postCard";
      d.setAttribute("data-post-id", x._id);
      d.innerHTML = renderPost(x);
      container.appendChild(d);
    });
  }catch(err){
    console.error("Load posts error", err);
  }
}

/* Delete post */
async function delPost(id){
  try{
    const confirm = await showModal({
        title: "Delete Post?",
        message: "Are you sure you want to delete this post?",
        type: "confirm",
        dangerous: true
    });
    if(!confirm) return;
    await fetch(API + "/api/post/delete", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ postId: id, username: USER })
    });
    loadPosts();
  }catch(err){
    console.error("Delete error", err);
  }
}

/* Vote */
async function vote(postId, type){
  // Check membership
  const post = POSTS_CACHE[postId];
  if(post && !isMember(post.community)){
      showToast("You must join r/" + post.community + " to vote.", 'error');
      return;
  }
  
  try{
    const res = await fetch(API + "/api/post/vote", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ postId, username: USER, type })
    });
    const data = await res.json();
    if(data.success){
      // Update the post in cache
      if(POSTS_CACHE[postId]){
        const post = POSTS_CACHE[postId];
        
        // Update upvotes/downvotes arrays
        if(!post.upvotes) post.upvotes = [];
        if(!post.downvotes) post.downvotes = [];
        
        const upIdx = post.upvotes.indexOf(USER);
        const downIdx = post.downvotes.indexOf(USER);
        
        if(type === 'up'){
          if(upIdx > -1){
            post.upvotes.splice(upIdx, 1); // Toggle off
          } else {
            if(downIdx > -1) post.downvotes.splice(downIdx, 1);
            post.upvotes.push(USER);
          }
        } else if(type === 'down'){
          if(downIdx > -1){
            post.downvotes.splice(downIdx, 1); // Toggle off
          } else {
            if(upIdx > -1) post.upvotes.splice(upIdx, 1);
            post.downvotes.push(USER);
          }
        }
        
        // Update UI directly - find the post's vote buttons
        const postElement = document.querySelector(`[data-post-id="${postId}"]`);
        if(postElement){
          const upBtn = postElement.querySelector('.voteBtn.up');
          const downBtn = postElement.querySelector('.voteBtn.down');
          const upSpan = postElement.querySelector('.vote-count-up');
          const downSpan = postElement.querySelector('.vote-count-down');
          
          // Update active states
          if(post.upvotes.includes(USER)){
            upBtn.classList.add('active');
          } else {
            upBtn.classList.remove('active');
          }
          
          if(post.downvotes.includes(USER)){
            downBtn.classList.add('active');
          } else {
            downBtn.classList.remove('active');
          }
          
          // Update counts
          if(upSpan) upSpan.textContent = post.upvotes.length;
          if(downSpan) downSpan.textContent = post.downvotes.length;
        }
      }
    }
  }catch(err){
    console.error("Vote error", err);
  }
}

/* Create post modal handlers */
function openPostModal(){
  if(!SELECTED) return alert("Choose a community first");
  document.getElementById("postModal").style.display = "flex";
  document.getElementById("postModal").setAttribute("aria-hidden","false");
  document.getElementById("postErr").innerText = "";
}
function closePostModal(){
  document.getElementById("postModal").style.display = "none";
  document.getElementById("postModal").setAttribute("aria-hidden","true");
}

/* Create post: uses FormData (no Content-Type set) */
async function makePost(){
  // Check membership
  if(SELECTED && !isMember(SELECTED)){
      showToast("You must join r/" + SELECTED + " to post.", 'error');
      return;
  }
  try{
    const title = document.getElementById("pTitle").value.trim();
    const content = document.getElementById("pText").value.trim();
    const community = SELECTED;
    const author = USER;

    if(!title || !community || !author){
      document.getElementById("postErr").innerText = "Missing required fields";
      return;
    }

    const fd = new FormData();
    fd.append("title", title);
    fd.append("content", content);
    fd.append("community", community);
    fd.append("author", author);

    const f = document.getElementById("imgInput").files[0];
    if(f) fd.append("image", f);

    const res = await fetch(API + "/api/post/create", { method:"POST", body: fd });
    const data = await res.json();
    if(data.success){
      closePostModal();
      // small delay to allow image to be written by server
      setTimeout(loadPosts, 300);
    } else {
      document.getElementById("postErr").innerText = data.msg || "Post failed";
    }
  }catch(err){
    console.error("Make post error", err);
    document.getElementById("postErr").innerText = "Server error";
  }
}

/* Edit Post */
let EDIT_ID = null;
function openEditModal(id){
  const post = POSTS_CACHE[id];
  if(!post) return;
  
  EDIT_ID = id;
  document.getElementById("eTitle").value = post.title;
  document.getElementById("eText").value = post.content || "";
  document.getElementById("editModal").style.display = "flex";
  document.getElementById("editModal").setAttribute("aria-hidden","false");
}
function closeEditModal(){
  document.getElementById("editModal").style.display = "none";
  document.getElementById("editModal").setAttribute("aria-hidden","true");
  EDIT_ID = null;
}
async function submitEdit(){
  console.log("submitEdit called, EDIT_ID:", EDIT_ID);
  if(!EDIT_ID) {
    showToast("Error: No post selected for editing", 'error');
    return;
  }
  const title = document.getElementById("eTitle").value.trim();
  const content = document.getElementById("eText").value.trim();
  if(!title) return showToast("Title required", 'error');

  try{
    const res = await fetch(API + "/api/post/edit", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ postId: EDIT_ID, username: USER, title, content })
    });
    const data = await res.json();
    if(data.success){
      closeEditModal();
      loadPosts();
      showToast("Post edited successfully", 'success');
    } else {
      showToast(data.msg || "Edit failed", 'error');
    }
  }catch(err){
    console.error("Edit error", err);
  }
}

/* Comments */
async function viewComments(pid, force = false){
  try{
    const box = document.getElementById("cmt_" + pid);
    if(!force && box.innerHTML !== "") {
        box.innerHTML = "";
        return;
    }
    const res = await fetch(API + "/api/comments", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ postId: pid })
    });
    const c = await res.json();
    box.innerHTML = "<hr>";
    
    // Add top-level comment input
    const inputDiv = document.createElement("div");
    inputDiv.style.marginTop = "10px";
    inputDiv.innerHTML = `
      <textarea id="newCmt_${pid}" placeholder="Write a comment..." rows="3"></textarea>
      <button class="createBtn" style="margin-top:5px" onclick="addTopLevelComment('${pid}')">Post Comment</button>
    `;
    box.appendChild(inputDiv);

    // Build tree
    const map = {};
    c.forEach(x => { x.children = []; map[x._id] = x; });
    const roots = [];
    c.forEach(x => {
      if(x.parentId && map[x.parentId]) map[x.parentId].children.push(x);
      else roots.push(x);
    });

    function render(node, level){
      const d = document.createElement("div");
      d.className = "commentBox";
      d.style.marginLeft = (level * 20) + "px";
      
      const upLen = (node.upvotes||[]).length;
      const downLen = (node.downvotes||[]).length;
      const score = upLen - downLen;
      const isUp = (node.upvotes||[]).includes(USER);
      const isDown = (node.downvotes||[]).includes(USER);

      d.innerHTML = `
        <div>
          <b>${escapeHtml(node.user)}</b>
          <span class="cmt-menu-btn" onclick="toggleCmtMenu(event, '${node._id}')">..</span>
          <div id="menu_${node._id}" class="cmt-menu">
            <div onclick="openProfile('${node.user}')">View Profile</div>
            <div onclick="openReply('${pid}','${node._id}')">Reply</div>
          </div>
          <div style="margin-top:2px;">${escapeHtml(node.text)}</div>
        </div>
        
        <div class="small" style="margin-top:6px; display:flex; align-items:center; gap:8px;">
          <!-- Vote Controls -->
          <div style="display:flex; align-items:center; gap:4px; background:#f5f5f5; padding:2px 6px; border-radius:12px;">
             <button class="voteBtn ${isUp?'active':''}" onclick="voteComment(event, '${node._id}', 'up')">▲</button>
             <span class="score" style="color:#ff4500">${upLen}</span>
             <button class="voteBtn ${isDown?'active':''}" onclick="voteComment(event, '${node._id}', 'down')">▼</button>
             <span class="score" style="color:#7193ff">${downLen}</span>
          </div>

          <span class="replyBtn" onclick="openReply('${pid}','${node._id}')">Reply</span>

          ${node.user === USER ? `
            <span class="replyBtn" onclick="openEditComment('${node._id}', '${escapeHtml(node.text)}')">Edit</span>
            <span class="replyBtn" style="color:red" onclick="deleteComment('${node._id}', '${pid}')">Delete</span>
          ` : ""}
        </div>
      `;
      box.appendChild(d);
      node.children.forEach(child => render(child, level+1));
    }
    
    roots.forEach(r => render(r, 0));

  }catch(err){
    console.error("View comments error", err);
  }
}

async function voteComment(e, cid, type){
  // Check membership - need PID
  // Try to find PID from DOM as before
  let box = null;
  if(e && e.target) box = e.target.closest("[id^='cmt_']");
  
  if(box){
     const pid = box.id.replace("cmt_", "");
     const post = POSTS_CACHE[pid];
     if(post && !isMember(post.community)){
         alert("You must join r/" + post.community + " to vote.");
         return;
     }
  }

  try{
    e.stopPropagation(); // prevent other clicks
    const res = await fetch(API + "/api/comment/vote", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ commentId: cid, username: USER, type })
    });
    const d = await res.json();
    if(d.success){
       // Update UI (reload is simplest for tree)
       // Use event target to find container
       const btn = e.target;
       const box = btn.closest("[id^='cmt_']");
       if(box){
          const pid = box.id.replace("cmt_", "");
          console.log("Reloading comments for post:", pid);
          viewComments(pid);
       } else {
           console.error("Could not find parent comment box to reload");
       }
    }
  }catch(err){ console.error(err); }
}

async function addTopLevelComment(pid){
  const post = POSTS_CACHE[pid];
  if(post && !isMember(post.community)){
      showToast("You must join r/" + post.community + " to comment.", 'error');
      return;
  }

  const txt = document.getElementById("newCmt_" + pid).value.trim();
  if(!txt) return;
  try{
    await fetch(API + "/api/comment/add", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ postId: pid, user: USER, text: txt })
    });
    viewComments(pid, true); // Reload comments
  }catch(e){ console.error(e); }
}

/* Edit Comment */
let EC_ID = null;
function openEditComment(id, text){
  EC_ID = id;
  document.getElementById("ecText").value = text;
  document.getElementById("editCommentModal").style.display = "flex";
  document.getElementById("editCommentModal").setAttribute("aria-hidden","false");
}
function closeEditComment(){
  document.getElementById("editCommentModal").style.display = "none";
  EC_ID = null;
}
async function submitEditComment(){
  if(!EC_ID) return;
  const text = document.getElementById("ecText").value.trim();
  if(!text) return;
  try{
    await fetch(API + "/api/comment/edit", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ commentId: EC_ID, user: USER, text })
    });
    closeEditComment();
    // Refresh comments? We need the post ID. 
    // Ideally we reload the whole post list or just comments. 
    // For simplicity, let's reload posts to keep it consistent.
    loadPosts(); 
  }catch(e){ console.error(e); }
}

/* Delete Comment */
async function deleteComment(id, pid){
  const confirm = await showModal({
      title: "Delete Comment?",
      message: "Are you sure you want to delete this comment?",
      type: "confirm",
      dangerous: true
  });
  if(!confirm) return;
  try{
    await fetch(API + "/api/comment/delete", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ commentId: id, user: USER })
    });
    // Refresh comments for this post
    viewComments(pid, true); 
  }catch(e){ console.error(e); }
}

/* Reply */
function openReply(post,parent){
  document.getElementById("replyModal").style.display = "flex";
  document.getElementById("replyModal").setAttribute("aria-hidden","false");
  REPLY_POST = post; PARENT = parent;
}
function closeReply(){
  document.getElementById("replyModal").style.display = "none";
  document.getElementById("replyModal").setAttribute("aria-hidden","true");
}

async function sendReply(){
  const post = POSTS_CACHE[REPLY_POST];
  if(post && !isMember(post.community)){
      showToast("You must join r/" + post.community + " to comment.", 'error');
      return;
  }
  
  try{
    const text = document.getElementById("replyText").value.trim();
    if(!text) return;
    await fetch(API + "/api/comment/add", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ postId: REPLY_POST, user: USER, text, parentId: PARENT })
    });
    closeReply();
    // Refresh comments only, keep post list as is
    viewComments(REPLY_POST, true);
  }catch(err){
    console.error("Send reply error", err);
  }
}

/* Create community */
async function createGroup(){
  const name = await showModal({
      title: "Create Community",
      message: "Enter a unique name for your new community.",
      type: "input",
      inputPlaceholder: "Community Name (e.g. Coding)"
  });
  if(!name) return;
  try{
    const res = await fetch(API + "/api/group/create", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ name, creator: USER })
    });
    const d = await res.json();
    if(d.success){
        loadGroups();
        showToast("Community created!", 'success');
    } else {
        showToast(d.msg || "Failed to create", 'error');
    }
  }catch(err){
    console.error("Create group error", err);
  }
}

async function deleteGroup(name){
  const confirm = await showModal({
      title: "Delete Community?",
      message: `Are you sure you want to delete r/${name}? This cannot be undone.`,
      type: "confirm",
      dangerous: true
  });
  if(!confirm) return;
  try{
    const res = await fetch(API + "/api/group/delete", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ name, username: USER })
    });
    const d = await res.json();
    if(d.success){
      loadGroups();
      if(SELECTED === name) location.reload(); // Reset if currently viewing
      showToast("Community deleted", 'success');
    } else {
      showToast(d.msg || "Delete failed", 'error');
    }
  }catch(e){ console.error(e); }
}

function toggleCommMenu(e, name){
  e.stopPropagation();
  // Close all menus
  document.querySelectorAll(".comm-menu").forEach(el => el.style.display = "none");
  document.querySelectorAll(".cmt-menu").forEach(el => el.style.display = "none");
  
  const menu = document.getElementById("comm_menu_" + name);
  if(menu){
    menu.style.display = "block";
  }
}

/* Logout */
function logout(){ 
  localStorage.removeItem("username"); 
  localStorage.removeItem("community"); 
  location.href="login.html"; 
}

/* Small helper for XSS-safe text */
function escapeHtml(str){
  if(!str && str !== 0) return "";
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

let ALL_COMMUNITIES = [];

async function searchCommunities(){
  const query = document.getElementById("searchInput").value.trim().toLowerCase();
  const resultsContainer = document.getElementById("searchResults");
  
  if(!query){
    resultsContainer.style.display = "none";
    return;
  }

  // Fetch all communities if not already loaded
  if(ALL_COMMUNITIES.length === 0){
    try{
      const res = await fetch(API + "/api/groups");
      ALL_COMMUNITIES = await res.json();
    }catch(err){
      console.error("Search error:", err);
      return;
    }
  }
  
  // Filter communities
  const filtered = ALL_COMMUNITIES.filter(c => 
    c.name.toLowerCase().includes(query)
  );
  
  if(filtered.length === 0){
    resultsContainer.innerHTML = "<div class='search-result-item' style='color:#999;'>No communities found</div>";
    resultsContainer.style.display = "block";
    return;
  }
  
  // Display results
  resultsContainer.innerHTML = "";
  filtered.forEach(c => {
    const item = document.createElement("div");
    item.className = "search-result-item";
    item.innerHTML = `
      <div style="font-weight:600;">r/${escapeHtml(c.name)}</div>
      <div style="font-size:12px;color:#666;margin-top:2px;">${c.members ? c.members.length : 0} members</div>
    `;
    item.onclick = () => {
      openComm(c.name);
      document.getElementById("searchInput").value = "";
      resultsContainer.style.display = "none";
    };
    resultsContainer.appendChild(item);
  });
  
  resultsContainer.style.display = "block";
}

// Close search if clicking outside
document.addEventListener("click", (e)=>{
  if(!e.target.closest(".search-container")) {
    document.getElementById("searchResults").style.display = "none";
  }
  // Close menus
  if(!e.target.closest(".comm-menu-btn") && !e.target.closest(".comm-menu")){
     document.querySelectorAll(".comm-menu").forEach(el => el.style.display = "none");
  }
  if(!e.target.closest(".cmt-menu-btn") && !e.target.closest(".cmt-menu")){
     document.querySelectorAll(".cmt-menu").forEach(el => el.style.display = "none");
  }
});

function toggleSidebar(){
  const s = document.querySelector(".sidebar");
  if(s.classList.contains("sidebar-hidden")){
    s.classList.remove("sidebar-hidden");
  } else {
    s.classList.add("sidebar-hidden");
  }
}

/* Profile Logic */
let CURRENT_PROFILE_USER = null;

async function openProfile(username){
  pushNavState({ view: 'profile', data: username });
  CURRENT_PROFILE_USER = username;
  
  // Hide posts, show profile
  document.getElementById("postsHere").style.display = "none";
  document.getElementById("selTitle").style.display = "none";
  document.querySelector(".createBtn").style.display = "none"; // Hide create post btn
  document.getElementById("communityPage").style.display = "none"; // Hide community page
  document.getElementById("profilePage").style.display = "block";
  
  // Reset fields
  document.getElementById("pName").innerText = username;
  document.getElementById("pAvatar").src = ""; 
  document.getElementById("pAbout").value = "";
  document.getElementById("pHobbies").value = "";
  
  // Fetch data
  try{
    const res = await fetch(API + "/api/user/profile", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ username })
    });
    const data = await res.json();
    if(data.success && data.data){
      const p = data.data;
      if(p.avatar) document.getElementById("pAvatar").src = API + p.avatar;
      document.getElementById("pAbout").value = p.about || "";
      document.getElementById("pHobbies").value = p.hobbies || "";
    }
  }catch(e){ console.error(e); }

  // Read-only check
  const isMe = (username === USER);
  document.getElementById("pAbout").disabled = !isMe;
  document.getElementById("pHobbies").disabled = !isMe;
  document.getElementById("pSaveBtn").style.display = isMe ? "inline-block" : "none";
  document.getElementById("pEditPicBtn").style.display = isMe ? "inline-block" : "none";
}

function closeProfile(){
  document.getElementById("profilePage").style.display = "none";
  document.getElementById("postsHere").style.display = "block";
  document.getElementById("selTitle").style.display = "block";
  document.querySelector(".createBtn").style.display = "inline-block";
}

async function saveProfile(){
  console.log("saveProfile called");
  console.log("CURRENT_PROFILE_USER:", CURRENT_PROFILE_USER);
  console.log("USER:", USER);
  
  if(CURRENT_PROFILE_USER !== USER) {
    console.log("Not authorized to edit this profile");
    return;
  }
  
  const about = document.getElementById("pAbout").value;
  const hobbies = document.getElementById("pHobbies").value;
  const file = document.getElementById("pAvatarInput").files[0];
  
  console.log("About:", about);
  console.log("Hobbies:", hobbies);
  console.log("File:", file);
  
  const fd = new FormData();
  fd.append("username", USER);
  fd.append("about", about);
  fd.append("hobbies", hobbies);
  if(file) fd.append("avatar", file);
  
  console.log("Sending request to:", API + "/api/user/update");
  
  try{
    const res = await fetch(API + "/api/user/update", { method:"POST", body: fd });
    console.log("Response status:", res.status);
    
    const d = await res.json();
    console.log("Response data:", d);
    
    if(d.success){
      alert("Profile saved!");
      openProfile(USER); // Reload
    } else {
      alert("Save failed: " + (d.msg || "Unknown error"));
    }
  }catch(e){ 
    console.error("Save profile error:", e); 
    alert("Error saving profile: " + e.message);
  }
}

function toggleCmtMenu(e, id){
  e.stopPropagation();
  // Close others
  document.querySelectorAll(".cmt-menu").forEach(el => el.style.display = "none");
  
  const menu = document.getElementById("menu_" + id);
  if(menu.style.display === "block"){
    menu.style.display = "none";
  } else {
    menu.style.display = "block";
    // Position it
    // menu.style.left = e.pageX + "px"; // Simple positioning
    // menu.style.top = e.pageY + "px";
  }
}

// Close menus on click elsewhere
document.addEventListener("click", () => {
  document.querySelectorAll(".cmt-menu").forEach(el => el.style.display = "none");
  document.querySelectorAll(".comm-menu").forEach(el => el.style.display = "none");
});

function toggleMemberMenu(e, memberName) {
  e.stopPropagation();
  // Close all other menus
  document.querySelectorAll('.cmt-menu').forEach(menu => {
    menu.style.display = 'none';
  });

  const menu = document.getElementById(`member_menu_${memberName}`);
  if (menu) {
    // Basic positioning (adjust as needed)
    menu.style.display = 'block';
  }
}

function toggleMembersList() {
  const membersList = document.getElementById('membersList');
  if (membersList.style.display === 'none') {
    membersList.style.display = 'block';
  } else {
    membersList.style.display = 'none';
  }
}

/* Global Chat Logic */
let CHAT_INTERVAL = null;

async function loadGlobalChat(){
  pushNavState({ view: 'chat' });
  // UI Switch
  document.getElementById("postsHere").style.display = "none";
  document.getElementById("selTitle").style.display = "none";
  document.querySelector(".createBtn").style.display = "none";
  document.getElementById("communityPage").style.display = "none";
  document.getElementById("profilePage").style.display = "none"; 
  document.getElementById("globalChatPage").style.display = "flex";
  document.getElementById("globalChatPage").style.flexDirection = "column";
  document.getElementById("globalChatPage").style.height = "calc(100vh - 100px)";

  // Stop previous polling if any
  if(CHAT_INTERVAL) clearInterval(CHAT_INTERVAL);
  
  await fetchGlobalMessages();
  
  // Start polling
  CHAT_INTERVAL = setInterval(fetchGlobalMessages, 2000);
}

// When leaving chat, stop polling
function stopChatPolling(){
  if(CHAT_INTERVAL) clearInterval(CHAT_INTERVAL);
}

// Hook into other load functions to stop chat logic
const originalLoadHome = loadHomeFeed;
loadHomeFeed = function(){
  // Stop Global Chat
  stopChatPolling();
  document.getElementById("globalChatPage").style.display = "none";
  
  // Stop Community Chat
  if(typeof IS_CHAT_OPEN !== 'undefined') IS_CHAT_OPEN = false;
  const sidebar = document.getElementById("communityChatSidebar");
  if(sidebar) sidebar.classList.remove("active");
  if(typeof COMM_CHAT_INTERVAL !== 'undefined' && COMM_CHAT_INTERVAL) clearInterval(COMM_CHAT_INTERVAL);
  
  originalLoadHome();
};

const originalOpenComm = openComm;
openComm = function(name){
  // Stop Global Chat
  stopChatPolling();
  document.getElementById("globalChatPage").style.display = "none";
  
  // Stop Community Chat
  if(typeof IS_CHAT_OPEN !== 'undefined') IS_CHAT_OPEN = false;
  const sidebar = document.getElementById("communityChatSidebar");
  if(sidebar) sidebar.classList.remove("active");
  if(typeof COMM_CHAT_INTERVAL !== 'undefined' && COMM_CHAT_INTERVAL) clearInterval(COMM_CHAT_INTERVAL);

  originalOpenComm(name);
};
 
const originalOpenProfile = openProfile;
openProfile = function(u){
  stopChatPolling();
  document.getElementById("globalChatPage").style.display = "none";
  originalOpenProfile(u);
}

async function fetchGlobalMessages(){
  try{
    const res = await fetch(API + "/api/chat/global");
    const msgs = await res.json();
    renderGlobalMessages(msgs);
  }catch(e){ console.error("Chat poll error", e); }
}

function renderGlobalMessages(msgs){
  const container = document.getElementById("chatMessages");
  const wasBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 50;
  
  container.innerHTML = "";
  msgs.forEach(m => {
    const isMe = m.user === USER;
    const date = new Date(m.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const div = document.createElement("div");
    div.className = `chat-bubble ${isMe ? 'mine' : 'others'}`;
    div.innerHTML = `
      ${!isMe ? `<span class="chat-user">${escapeHtml(m.user)}</span>` : ""}
      <span>${escapeHtml(m.text)}</span>
      ${m.image ? `<br><img src="${API + m.image}" style="max-width:200px; max-height:200px; border-radius:8px; margin-top:6px;" alt="image">` : ""}
      <span class="chat-time">${date}</span>
    `;
    container.appendChild(div);
  });
  
  // Auto-scroll if was at bottom
  if(wasBottom) container.scrollTop = container.scrollHeight;
}

async function sendGlobalMessage(){
  const txt = document.getElementById("chatInput").value.trim();
  const file = document.getElementById("globalChatImage").files[0];
  
  if(!txt && !file) return;
  
  document.getElementById("chatInput").value = ""; // Clear immediately
  document.getElementById("globalChatImage").value = ""; // Clear file input
  
  try{
    const fd = new FormData();
    fd.append("user", USER);
    fd.append("text", txt || " "); // Send space if only image
    if(file) fd.append("image", file);
    
    await fetch(API + "/api/chat/global", {
      method:"POST",
      body: fd
    });
    fetchGlobalMessages(); // Refresh immediately
  }catch(e){ console.error("Send chat error", e); }
}

/* --- Community Chat Sidebar Logic --- */
let COMM_CHAT_INTERVAL = null;
let IS_CHAT_OPEN = false;

function toggleCommunityChat() {
  const sidebar = document.getElementById("communityChatSidebar");
  const wrapper = document.querySelector(".community-content-wrapper");
  
  if(!CURRENT_COMMUNITY) {
    showToast("Select a community first", 'error');
    return;
  }
  
  if(!isMember(CURRENT_COMMUNITY.name)){
    showToast("You must join r/" + CURRENT_COMMUNITY.name + " to participate in live chat.", 'error');
    return;
  }

  if(!IS_CHAT_OPEN) {
    // OPEN CHAT
    IS_CHAT_OPEN = true;
    sidebar.classList.add("active");
    wrapper.classList.add("chat-active");
    
    if(CURRENT_COMMUNITY) {
        document.getElementById("commChatTitleSidebar").innerText = "Chat: r/" + CURRENT_COMMUNITY.name;
        fetchCommunityMessages();
        if(COMM_CHAT_INTERVAL) clearInterval(COMM_CHAT_INTERVAL);
        COMM_CHAT_INTERVAL = setInterval(fetchCommunityMessages, 2000);
    }
  } else {
    // CLOSE CHAT
    IS_CHAT_OPEN = false;
    sidebar.classList.remove("active");
    wrapper.classList.remove("chat-active");
    if(COMM_CHAT_INTERVAL) clearInterval(COMM_CHAT_INTERVAL);
  }
}

async function fetchCommunityMessages() {
    if(!CURRENT_COMMUNITY || !IS_CHAT_OPEN) return;
    try {
        const res = await fetch(API + "/api/chat/community/" + CURRENT_COMMUNITY.name);
        const msgs = await res.json();
        renderCommunityChat(msgs);
    } catch(e) { console.error(e); }
}

function renderCommunityChat(msgs) {
    const container = document.getElementById("commChatMessages");
    const wasBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 50;
    
    container.innerHTML = "";
    msgs.forEach(m => {
        const isMe = m.user === USER;
        // Simple time format - use createdAt or updatedAt
        const timestamp = m.createdAt || m.updatedAt;
        const time = new Date(timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        const div = document.createElement("div");
        div.style.marginBottom = "8px";
        div.style.display = "flex";
        div.style.flexDirection = "column";
        div.style.alignItems = isMe ? "flex-end" : "flex-start";
        
        div.innerHTML = `
            <div style="font-size:11px; color:#666; margin-bottom:2px;">${isMe ? 'You' : escapeHtml(m.user)} <span style="font-size:9px;">${time}</span></div>
            <div style="background:${isMe ? '#ff4500' : '#e0e0e0'}; color:${isMe ? 'white' : 'black'}; padding:6px 10px; border-radius:12px; max-width:90%; word-wrap:break-word;">
                ${escapeHtml(m.text)}
                ${m.image ? `<br><img src="${API + m.image}" style="max-width:180px; max-height:180px; border-radius:8px; margin-top:6px;" alt="image">` : ""}
            </div>
        `;
        container.appendChild(div);
    });
    
    if(wasBottom) container.scrollTop = container.scrollHeight;
}

async function sendCommunityMessage() {
    if(!CURRENT_COMMUNITY) return;
    
    if(!isMember(CURRENT_COMMUNITY.name)){
        alert("You must join this community to send messages.");
        return;
    }

    const input = document.getElementById("commChatInput");
    const txt = input.value.trim();
    const file = document.getElementById("commChatImage").files[0];
    
    if(!txt && !file) return;
    
    input.value = "";
    document.getElementById("commChatImage").value = "";
    
    try {
        const fd = new FormData();
        fd.append("community", CURRENT_COMMUNITY.name);
        fd.append("user", USER);
        fd.append("text", txt || " "); // Send space if only image
        if(file) fd.append("image", file);
        
        await fetch(API + "/api/chat/community", {
            method: "POST",
            body: fd
        });
        fetchCommunityMessages(); // Refresh immediately
    } catch(e) { console.error("Send error:", e); }
}

// Trigger send on Enter key
document.getElementById("commChatInput").addEventListener("keypress", (e) => {
    if(e.key === "Enter") sendCommunityMessage();
});

/* --- Admin Moderation Functions --- */

// Promote member to subadmin (admin only, max 2)
async function promoteSubadmin(communityName, targetUser) {
  if(!confirm(`Promote ${targetUser} to subadmin?`)) return;
  
  try {
    const res = await fetch(API + "/api/community/promote", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        communityName, 
        username: USER, 
        targetUser 
      })
    });
    const data = await res.json();
    
    if(data.success) {
      alert(`${targetUser} is now a subadmin!`);
      loadCommunityPage(communityName); // Reload to reflect changes
    } else {
      alert(data.msg || "Failed to promote user");
    }
  } catch(e) {
    console.error("Promote error:", e);
    alert("Error promoting user");
  }
}

// Demote subadmin to regular member (admin only)
async function demoteSubadmin(communityName, targetUser) {
  if(!confirm(`Demote ${targetUser} from subadmin?`)) return;
  
  try {
    const res = await fetch(API + "/api/community/demote", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        communityName, 
        username: USER, 
        targetUser 
      })
    });
    const data = await res.json();
    
    if(data.success) {
      alert(`${targetUser} has been demoted to regular member`);
      loadCommunityPage(communityName); // Reload
    } else {
      alert(data.msg || "Failed to demote user");
    }
  } catch(e) {
    console.error("Demote error:", e);
    alert("Error demoting user");
  }
}

// Kick member from community (admin or subadmin)
async function kickMember(communityName, targetUser) {
  if(!confirm(`Kick ${targetUser} from r/${communityName}? They can rejoin later.`)) return;
  
  try {
    const res = await fetch(API + "/api/community/kick", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        communityName, 
        username: USER, 
        targetUser 
      })
    });
    const data = await res.json();
    
    if(data.success) {
      alert(`${targetUser} has been kicked from the community`);
      loadCommunityPage(communityName); // Reload
    } else {
      alert(data.msg || "Failed to kick member");
    }
  } catch(e) {
    console.error("Kick error:", e);
    alert("Error kicking member");
  }
}

// Ban user from community (admin or subadmin)
async function banUser(communityName, targetUser) {
  if(!confirm(`Ban ${targetUser} from r/${communityName}? This will remove them and prevent them from posting/commenting.`)) return;
  
  try {
    const res = await fetch(API + "/api/community/ban", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        communityName, 
        username: USER, 
        targetUser 
      })
    });
    const data = await res.json();
    
    if(data.success) {
      alert(`${targetUser} has been banned from the community`);
      loadCommunityPage(communityName); // Reload
    } else {
      alert(data.msg || "Failed to ban user");
    }
  } catch(e) {
    console.error("Ban error:", e);
    alert("Error banning user");
  }
}

// Unban user from community (admin only)
async function unbanUser(communityName, targetUser) {
  if(!confirm(`Unban ${targetUser} from r/${communityName}?`)) return;
  
  try {
    const res = await fetch(API + "/api/community/unban", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        communityName, 
        username: USER, 
        targetUser 
      })
    });
    const data = await res.json();
    
    if(data.success) {
      alert(`${targetUser} has been unbanned`);
      loadCommunityPage(communityName); // Reload
    } else {
      alert(data.msg || "Failed to unban user");
    }
  } catch(e) {
    console.error("Unban error:", e);
    alert("Error unbanning user");
  }
}

// Toggle Community Status (Close/Open)
async function toggleCommunityStatus(communityName) {
  try {
    const res = await fetch(API + "/api/community/toggle-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ communityName, username: USER })
    });
    const data = await res.json();
    if(data.success) {
      alert(`Community is now ${data.isClosed ? "Closed" : "Open"}`);
      loadCommunityPage(communityName);
    } else {
      alert(data.msg || "Failed");
    }
  } catch(e) {
    console.error(e);
  }
}

/* --- NOTIFICATIONS & INVITATIONS SYSTEM --- */

let NOTIF_INTERVAL = null;
let NOTIF_OPEN = false;

function toggleNotifications() {
  const dropdown = document.getElementById("notifDropdown");
  NOTIF_OPEN = !NOTIF_OPEN;
  if (NOTIF_OPEN) {
    dropdown.classList.add("active");
    fetchNotifications();
    if (NOTIF_INTERVAL) clearInterval(NOTIF_INTERVAL);
    NOTIF_INTERVAL = setInterval(fetchNotifications, 30000);
  } else {
    dropdown.classList.remove("active");
    if (NOTIF_INTERVAL) clearInterval(NOTIF_INTERVAL);
  }
}

async function fetchNotifications() {
  try {
    const res = await fetch(API + `/api/notifications?username=${USER}`);
    const data = await res.json();
    if (data.success) {
      renderNotifications(data.notifications);
      const unread = data.notifications.filter(n => !n.read).length;
      const badge = document.getElementById("notifBadge");
      if (unread > 0) {
        badge.textContent = unread > 9 ? '9+' : unread;
        badge.style.display = "flex";
      } else {
        badge.style.display = "none";
      }
    }
  } catch (e) { console.error(e); }
}

function renderNotifications(notifications) {
  const container = document.getElementById("notifList");
  if (!notifications || notifications.length === 0) {
    container.innerHTML = '<p class="small" style="padding:20px;text-align:center;color:#999">No notifications</p>';
    return;
  }
  container.innerHTML = "";
  notifications.forEach(notif => {
    const div = document.createElement("div");
    div.className = `notif-item ${notif.read ? '' : 'unread'}`;
    div.onclick = () => markNotificationRead(notif._id);
    let icon = "🔔";
    if (notif.type === 'kick') icon = "👢";
    if (notif.type === 'ban') icon = "🚫";
    if (notif.type === 'invitation') icon = "📧";
    if (notif.type === 'invitation_accepted') icon = "✅";
    const time = new Date(notif.createdAt).toLocaleString();
    let actionsHtml = '';
    // Only show Accept/Reject buttons for unread invitations
    if (notif.type === 'invitation' && notif.invitationId && !notif.read) {
      actionsHtml = `<div class="notif-actions"><button class="accept-btn" onclick="acceptInvitation(event, '${notif.invitationId}')">Accept</button><button class="reject-btn" onclick="rejectInvitation(event, '${notif.invitationId}')">Reject</button></div>`;
    } else if (notif.type === 'invitation' && notif.read) {
      actionsHtml = '<p style="font-size:11px;color:#999;margin-top:6px;font-style:italic;">Invitation responded</p>';
    }
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:start">
         <div class="notif-message flex-grow"><span class="notif-icon">${icon}</span>${escapeHtml(notif.message)}</div>
         <span class="cmt-menu-btn" style="color:#aaa; cursor:pointer;" onclick="deleteNotification(event, '${notif._id}')">&times;</span>
      </div>
      <div class="notif-time">${time}</div>${actionsHtml}`;
    container.appendChild(div);
  });
}

async function markNotificationRead(id) {
  try {
    await fetch(API + `/api/notification/read/${id}`, { method: "POST" });
    fetchNotifications();
  } catch (e) { console.error(e); }
}

async function deleteNotification(e, id) {
  e.stopPropagation();
  try {
    // Optimistic UI update
    const el = e.target.closest('.notif-item');
    if(el) el.style.display = 'none';

    await fetch(API + `/api/notification/delete/${id}`, { method: "POST" });
    fetchNotifications();
  } catch(e) { console.error(e); }
}

async function clearReadNotifications() {
  console.log("clearReadNotifications called for user:", USER);
  try {
    const res = await fetch(API + "/api/notifications/clear", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username: USER }) });
    const data = await res.json();
    console.log("Clear notifications response:", data);
    fetchNotifications();
  } catch (e) { console.error("Clear notifications error:", e); }
}

async function acceptInvitation(e, invitationId) {
  e.stopPropagation();
  try {
    const res = await fetch(API + `/api/invitation/accept/${invitationId}`, { method: "POST" });
    const data = await res.json();
    if (data.success) {
      showToast("Invitation accepted!", 'success');
      fetchNotifications();
      loadGroups();
    } else {
      showToast(data.msg || "Failed", 'error');
    }
  } catch (e) { console.error(e); }
}

async function rejectInvitation(e, invitationId) {
  e.stopPropagation();
  
  try {
    const res = await fetch(API + `/api/invitation/reject/${invitationId}`, { method: "POST" });
    const data = await res.json();
    
    if (data.success || res.ok) {
      // Find and mark the notification as read
      const notifications = await fetch(API + `/api/notifications?username=${USER}`);
      const notifData = await notifications.json();
      
      if (notifData.success) {
        const relatedNotif = notifData.notifications.find(n => n.invitationId === invitationId);
        if (relatedNotif && relatedNotif._id) {
          await fetch(API + `/api/notification/read/${relatedNotif._id}`, { method: "POST" });
        }
      }
      
      showToast("Invitation rejected", 'info');
      fetchNotifications();
    }
  } catch (e) { 
    console.error(e); 
  }
}

async function sendInvitation(communityName, targetUser) {
  try {
    const res = await fetch(API + "/api/invitation/send", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ community: communityName, from: USER, to: targetUser }) });
    const data = await res.json();
    if (data.success) showToast(`Invitation sent to ${targetUser}!`, 'success');
    else showToast(data.msg || "Failed", 'error');
  } catch (e) { console.error(e); }
}

function openFindMembers() {
  pushNavState({ view: 'members' });
  document.getElementById("postsHere").style.display = "none";
  document.getElementById("selTitle").style.display = "none";
  document.querySelector(".createBtn").style.display = "none";
  document.getElementById("profilePage").style.display = "none";
  document.getElementById("globalChatPage").style.display = "none";
  document.getElementById("communityPage").style.display = "none";
  document.getElementById("findMembersPage").style.display = "block";
  
  loadRandomUsers();
  checkRefreshCooldown();
}

async function searchUsersToInvite() {
  const query = document.getElementById("findMembersSearch").value.trim();
  if (!query) return;
  try {
    const res = await fetch(API + `/api/users/search?q=${encodeURIComponent(query)}`);
    const data = await res.json();
    if (data.success) renderUsersList(data.users, "userSearchResults");
  } catch (e) { console.error(e); }
}

async function loadRandomUsers() {
  try {
    let community = CURRENT_COMMUNITY ? CURRENT_COMMUNITY.name : null;
    const url = `${API}/api/users/random?username=${USER}&limit=15${community ? '&community=' + encodeURIComponent(community) : ''}`;
    
    const res = await fetch(url);
    const data = await res.json();
    
    if (data.success) {
      const count = data.users.length;
      document.getElementById("randomUserCount").textContent = `(${count}/15)`;
      renderUsersList(data.users, "randomUsersList");
    }
  } catch (e) { 
    console.error(e); 
  }
}

// Refresh with cooldown
function refreshRandomUsers() {
  const lastRefresh = localStorage.getItem('lastRandomRefresh');
  const now = Date.now();
  const cooldown = 30 * 60 * 1000; // 30 minutes in milliseconds
  
  if (lastRefresh) {
    const timeSinceRefresh = now - parseInt(lastRefresh);
    if (timeSinceRefresh < cooldown) {
      const remainingMs = cooldown - timeSinceRefresh;
      const remainingMin = Math.ceil(remainingMs / 60000);
      showToast(`Please wait ${remainingMin} more minute(s) before refreshing again.`, 'error');
      return;
    }
  }
  
  // Allow refresh
  localStorage.setItem('lastRandomRefresh', now.toString());
  loadRandomUsers();
  startCooldownTimer();
}

// Start cooldown timer display
function startCooldownTimer() {
  const lastRefresh = localStorage.getItem('lastRandomRefresh');
  if (!lastRefresh) return;
  
  const cooldown = 30 * 60 * 1000;
  const btn = document.getElementById('refreshUsersBtn');
  const timer = document.getElementById('cooldownTimer');
  
  function updateTimer() {
    const now = Date.now();
    const elapsed = now - parseInt(lastRefresh);
    const remaining = cooldown - elapsed;
    
    if (remaining <= 0) {
      btn.disabled = false;
      btn.style.opacity = '1';
      timer.style.display = 'none';
      return;
    }
    
    btn.disabled = true;
    btn.style.opacity = '0.5';
    btn.style.cursor = 'not-allowed';
    
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    timer.textContent = `Next refresh available in ${minutes}m ${seconds}s`;
    timer.style.display = 'block';
    
    setTimeout(updateTimer, 1000);
  }
  
  updateTimer();
}

// Check cooldown on page load
function checkRefreshCooldown() {
  const lastRefresh = localStorage.getItem('lastRandomRefresh');
  if (lastRefresh) {
    const now = Date.now();
    const elapsed = now - parseInt(lastRefresh);
    const cooldown = 30 * 60 * 1000;
    
    if (elapsed < cooldown) {
      startCooldownTimer();
    }
  }
}

function renderUsersList(users, containerId) {
  const container = document.getElementById(containerId);
  if (!users || users.length === 0) {
    container.innerHTML = '<p class="small" style="color:#999">No users found</p>';
    return;
  }
  container.innerHTML = "";
  users.forEach(user => {
    const div = document.createElement("div");
    div.className = "user-list-item";
    const avatarSrc = user.avatar ? API + user.avatar : "https://via.placeholder.com/32";
    div.innerHTML = `<div class="user-info"><img src="${avatarSrc}" class="user-avatar-small" onerror="this.src='https://via.placeholder.com/32'"><span>${escapeHtml(user.username)}</span></div><button class="invite-btn" onclick="inviteUserToCommunity('${user.username}')">Invite</button>`;
    container.appendChild(div);
  });
}

async function inviteUserToCommunity(username) {
  if (!CURRENT_COMMUNITY) {
    // Prompt user to select a community
    const communities = ALL_COMMUNITIES.filter(c => 
      (c.creator === USER || (c.subadmins && c.subadmins.includes(USER))) && c.name !== 'Suggestions'
    );
    
    if (communities.length === 0) {
      showToast("You must be a member of at least one community to send invitations.", 'error');
      return;
    }
    
    // Show community selection
    const selectedCommunity = await showModal({
        title: "Select Community",
        message: `Choose a community to invite ${username} to:`,
        type: "select",
        options: communities.map(c => ({ label: "r/" + c.name, value: c.name }))
    });
    
    if (!selectedCommunity) return;
    
    try {
      const res = await fetch(API + "/api/invitation/send", { 
        method: "POST", 
        headers: { "Content-Type": "application/json" }, 
        body: JSON.stringify({ 
          community: selectedCommunity, 
          from: USER, 
          to: username 
        }) 
      });
      const data = await res.json();
      if (data.success) showToast(`Invitation sent to ${username} for r/${selectedCommunity}!`, 'success');
      else showToast(data.msg || "Failed", 'error');
    } catch (e) { 
      console.error(e); 
      showToast("Error sending invitation", 'error');
    }
    
    return;
  }
  
  // If CURRENT_COMMUNITY exists, use it directly
  try {
    const res = await fetch(API + "/api/invitation/send", { 
      method: "POST", 
      headers: { "Content-Type": "application/json" }, 
      body: JSON.stringify({ 
        community: CURRENT_COMMUNITY.name, 
        from: USER, 
        to: username 
      }) 
    });
    const data = await res.json();
    if (data.success) showToast(`Invitation sent to ${username}!`, 'success');
    else showToast(data.msg || "Failed", 'error');
  } catch (e) { 
    console.error(e); 
    showToast("Error sending invitation", 'error');
  }
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer') || createToastContainer();
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `<span>${message}</span>`; // Use innerHTML for flexibility
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'fadeOut 0.3s forwards';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function createToastContainer() {
    const div = document.createElement('div');
    div.id = 'toastContainer';
    div.className = 'toast-container';
    document.body.appendChild(div);
    return div;
}

fetchNotifications();
setInterval(fetchNotifications, 60000);

document.addEventListener("click", (e) => {
  const dropdown = document.getElementById("notifDropdown");
  const notifBtn = document.querySelector(".notif-btn");
  if (NOTIF_OPEN && !dropdown.contains(e.target) && !notifBtn.contains(e.target)) {
    toggleNotifications();
  }
});


/* === Custom Modal Helper === */
function showModal({ title, message, type = 'alert', inputPlaceholder = '', options = [], dangerous = false } = {}) {
    return new Promise((resolve) => {
        // Remove existing
        const existing = document.getElementById('customModal');
        if (existing) existing.remove();

        const overlay = document.createElement('div');
        overlay.id = 'customModal';
        overlay.className = 'modal-overlay';

        let bodyContent = '';
        if (type === 'input') {
            bodyContent = `<input type="text" class="modal-input" placeholder="${inputPlaceholder}" id="modalInput">`;
        } else if (type === 'select') {
            const listItems = options.map((opt, i) => 
                `<div class="modal-list-item" data-value="${opt.value}">${opt.label}</div>`
            ).join('');
            bodyContent = `<div class="modal-list" id="modalList">${listItems}</div>`;
        }

        const confirmClass = dangerous ? 'confirm danger' : 'confirm';
        const confirmText = dangerous ? 'Delete' : (type === 'select' ? 'Select' : 'Confirm');

        overlay.innerHTML = `
            <div class="modal-content">
                <div class="modal-title">${title}</div>
                ${message ? `<div class="modal-desc">${message}</div>` : ''}
                ${bodyContent}
                <div class="modal-actions">
                    <button class="modal-btn cancel" id="modalCancel">Cancel</button>
                    <button class="modal-btn ${confirmClass}" id="modalConfirm">${confirmText}</button>
                </div>
            </div>
        `;

        document.body.appendChild(overlay);

        // Animation in
        requestAnimationFrame(() => overlay.classList.add('active'));

        const input = document.getElementById('modalInput');
        if (input) input.focus();

        /* Selection Logic */
        let selectedValue = null;
        if (type === 'select') {
            const items = overlay.querySelectorAll('.modal-list-item');
            items.forEach(item => {
                item.onclick = () => {
                    items.forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    selectedValue = item.dataset.value;
                };
                item.ondblclick = () => {
                     // Double click select
                     close(item.dataset.value);
                }
            });
        }

        function close(value) {
            overlay.classList.remove('active');
            setTimeout(() => {
                overlay.remove();
                resolve(value);
            }, 300);
        }

        document.getElementById('modalCancel').onclick = () => close(null);
        document.getElementById('modalConfirm').onclick = () => {
            if (type === 'input') {
                const val = input.value.trim();
                if (!val) {
                    input.style.borderColor = '#ff4757';
                     input.style.animation = 'shake 0.3s';
                     setTimeout(()=>input.style.animation='',300);
                     return; 
                }
                close(val);
            } else if (type === 'select') {
                if (!selectedValue) {
                    showToast("Please select an option", "error");
                    return;
                }
                close(selectedValue);
            } else {
                close(true); // Confirm
            }
        };
        
        // Enter key for input
         if(type === 'input') {
             input.onkeydown = (e) => {
                 if(e.key === 'Enter') document.getElementById('modalConfirm').click();
             }
         }
    });
}

// === Developer Tools Functions ===
async function openDevTools() {
  // Check if user is in r/Dev
  const devComm = ALL_COMMUNITIES.find(c => c.name === 'Dev');
  if (!devComm || !devComm.members.includes(USER)) {
    showToast("Only r/Dev members can access Developer Tools", "error");
    return;
  }
  
  document.getElementById('devToolsModal').style.display = 'flex';
  document.getElementById('devToolsSearch').value = '';
  document.getElementById('devToolsResults').innerHTML = '';
}

function closeDevTools() {
  document.getElementById('devToolsModal').style.display = 'none';
}

async function searchCommunitiesForVerification() {
  const query = document.getElementById('devToolsSearch').value.trim();
  if (!query) {
    showToast("Please enter a search term", "error");
    return;
  }
  
  try {
    const res = await fetch(API + `/api/community/search?q=${encodeURIComponent(query)}`);
    const communities = await res.json();
    
    const resultsDiv = document.getElementById('devToolsResults');
    if (communities.length === 0) {
      resultsDiv.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No communities found</p>';
      return;
    }
    
    resultsDiv.innerHTML = communities.map(comm => `
      <div class="dev-community-item">
        <div class="dev-community-info">
          ${comm.icon ? `<img src="${comm.icon}" class="dev-community-icon" onerror="this.style.display='none'">` : ''}
          <div>
            <div style="font-weight:600;">r/${comm.name}</div>
            <div style="font-size:12px;color:#666;">${comm.members.length} members</div>
          </div>
        </div>
        <button 
          class="verify-toggle-btn ${comm.isVerified ? 'verified' : 'unverified'}"
          onclick="toggleCommunityVerification('${comm.name}', ${comm.isVerified})"
        >
          ${comm.isVerified ? '✓ Verified' : 'Verify'}
        </button>
      </div>
    `).join('');
  } catch (e) {
    console.error(e);
    showToast("Error searching communities", "error");
  }
}

async function toggleCommunityVerification(communityName, currentStatus) {
  try {
    const res = await fetch(API + '/api/community/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ communityName, username: USER })
    });
    
    const data = await res.json();
    if (data.success) {
      showToast(`r/${communityName} ${data.isVerified ? 'verified' : 'verification removed'}`, "success");
      // Refresh search results
      searchCommunitiesForVerification();
      // Reload groups to update badges
      loadGroups();
    } else {
      showToast(data.msg || "Error toggling verification", "error");
    }
  } catch (e) {
    console.error(e);
    showToast("Error toggling verification", "error");
  }
}

function getVerifiedBadge() {
  return '<span class="verified-badge">✓</span>';
}

// === Admin Badge Functions ===
function getAdminBadge() {
  return '<img src="/assets/admin_badge.png" class="admin-badge" title="Verified Community Admin">';
}

function getDevBadge() {
  return '<img src="/assets/developer_badge.png" class="dev-badge" title="r/Dev Member">';
}

// === Admin Tools Functions ===
let CURRENT_DM_PARTNER = null;
let CURRENT_ROOM_ID = null;
let DM_POLL_INTERVAL = null;
let ROOM_POLL_INTERVAL = null;
let IS_VERIFIED_ADMIN = false;

function checkIfVerifiedAdmin() {
  // Check if user is admin (creator) of any verified community
  const verifiedCommunities = ALL_COMMUNITIES.filter(c => c.isVerified);
  return verifiedCommunities.some(c => c.creator === USER);
}

async function openAdminTools() {
  // Check if user is admin of any verified community
  if (!checkIfVerifiedAdmin()) {
    showToast("Only verified community admins can access Admin Tools", "error");
    return;
  }
  
  document.getElementById('adminToolsModal').style.display = 'flex';
  
  // Check if user is r/Dev member for rooms tab
  const devComm = ALL_COMMUNITIES.find(c => c.name === 'Dev');
  const isDevMember = devComm && devComm.members.includes(USER);
  document.getElementById('roomsTab').style.display = isDevMember ? 'inline-block' : 'none';
  
  // Load admins tab by default
  switchAdminTab('admins');
}

function closeAdminTools() {
  document.getElementById('adminToolsModal').style.display = 'none';
}

function switchAdminTab(tab, e) {
  // Update tab buttons
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  
  // Add active class - either from event or find the right button
  if (e && e.target) {
    e.target.classList.add('active');
  } else {
    // Find button by tab name and activate it
    const tabNames = { 'admins': 0, 'conversations': 1, 'rooms': 2 };
    const buttons = document.querySelectorAll('.admin-tab');
    if (buttons[tabNames[tab]]) buttons[tabNames[tab]].classList.add('active');
  }
  
  // Hide all tabs
  document.getElementById('adminTabAdmins').style.display = 'none';
  document.getElementById('adminTabConversations').style.display = 'none';
  document.getElementById('adminTabRooms').style.display = 'none';
  
  // Show selected tab
  document.getElementById('adminTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).style.display = 'block';
  
  // Load tab content
  if (tab === 'admins') loadVerifiedAdmins();
  else if (tab === 'conversations') loadConversations();
  else if (tab === 'rooms') loadRooms();
}

async function loadVerifiedAdmins() {
  const container = document.getElementById('adminTabAdmins');
  container.innerHTML = '<p style="text-align:center;color:#666;">Loading...</p>';
  
  try {
    const res = await fetch(API + `/api/verified-admins?username=${USER}`);
    const admins = await res.json();
    
    if (admins.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#666;">No verified community admins found</p>';
      return;
    }
    
    container.innerHTML = admins.map(admin => `
      <div class="admin-list-item">
        <div class="admin-info">
          <img src="${admin.avatar ? API + admin.avatar : 'https://via.placeholder.com/50'}" class="admin-avatar" onerror="this.src='https://via.placeholder.com/50'">
          <div class="admin-details">
            <h4>
              ${escapeHtml(admin.username)}
              ${getAdminBadge()}
              ${admin.isDevMember ? getDevBadge() : ''}
            </h4>
            <p>Admin of: ${admin.communities.map(c => 'r/' + c).join(', ')}</p>
          </div>
        </div>
        <div class="admin-actions">
          <button onclick="openProfile('${admin.username}')" style="padding:8px 16px;background:#f0f0f0;border:none;border-radius:8px;cursor:pointer;">Profile</button>
          <button onclick="startDMChat('${admin.username}')" style="padding:8px 16px;background:var(--gradient-primary);color:white;border:none;border-radius:8px;cursor:pointer;">💬 Chat</button>
        </div>
      </div>
    `).join('');
  } catch (e) {
    console.error(e);
    container.innerHTML = '<p style="text-align:center;color:red;">Error loading admins</p>';
  }
}

async function loadConversations() {
  const container = document.getElementById('adminTabConversations');
  container.innerHTML = '<p style="text-align:center;color:#666;">Loading...</p>';
  
  try {
    const res = await fetch(API + `/api/dm/conversations?username=${USER}`);
    const conversations = await res.json();
    
    if (conversations.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#666;">No conversations yet. Start chatting with other admins!</p>';
      return;
    }
    
    container.innerHTML = conversations.map(conv => `
      <div class="room-item" onclick="startDMChat('${conv.partner}')">
        <div>
          <strong>${escapeHtml(conv.partner)}</strong>
          <p style="margin:4px 0 0;font-size:13px;color:#666;">${escapeHtml(conv.lastMessage)}</p>
        </div>
        ${conv.unread > 0 ? `<span style="background:#ff4500;color:white;padding:4px 10px;border-radius:12px;font-size:12px;">${conv.unread}</span>` : ''}
      </div>
    `).join('');
  } catch (e) {
    console.error(e);
    container.innerHTML = '<p style="text-align:center;color:red;">Error loading conversations</p>';
  }
}

async function loadRooms() {
  const container = document.getElementById('adminTabRooms');
  
  // Check if user is r/Dev member
  const devComm = ALL_COMMUNITIES.find(c => c.name === 'Dev');
  const isDevMember = devComm && devComm.members.includes(USER);
  
  let html = '';
  if (isDevMember) {
    html += '<button class="create-room-btn" onclick="createRoom()">+ Create New Room</button>';
  }
  
  try {
    const res = await fetch(API + `/api/room/list?username=${USER}`);
    const rooms = await res.json();
    
    if (rooms.length === 0) {
      html += '<p style="text-align:center;color:#666;">No rooms yet.</p>';
    } else {
      html += rooms.map(room => `
        <div class="room-item" onclick="openRoomChat('${room._id}')">
          <div>
            <strong>${escapeHtml(room.name)}</strong>
            <p style="margin:4px 0 0;font-size:13px;color:#666;">${room.members.length} members</p>
          </div>
          <span style="color:#666;">→</span>
        </div>
      `).join('');
    }
    
    container.innerHTML = html;
  } catch (e) {
    console.error(e);
    container.innerHTML = html + '<p style="text-align:center;color:red;">Error loading rooms</p>';
  }
}

// === DM Chat Functions ===
async function startDMChat(partner) {
  CURRENT_DM_PARTNER = partner;
  document.getElementById('dmChatPartner').innerText = partner;
  document.getElementById('dmChatPanel').classList.add('open');
  document.getElementById('dmChatInput').value = '';
  
  await loadDMMessages();
  
  // Start polling
  if (DM_POLL_INTERVAL) clearInterval(DM_POLL_INTERVAL);
  DM_POLL_INTERVAL = setInterval(loadDMMessages, 3000);
}

function closeDMChat() {
  document.getElementById('dmChatPanel').classList.remove('open');
  CURRENT_DM_PARTNER = null;
  if (DM_POLL_INTERVAL) {
    clearInterval(DM_POLL_INTERVAL);
    DM_POLL_INTERVAL = null;
  }
}

async function loadDMMessages() {
  if (!CURRENT_DM_PARTNER) return;
  
  try {
    const res = await fetch(API + `/api/dm/${CURRENT_DM_PARTNER}?username=${USER}`);
    const messages = await res.json();
    
    const container = document.getElementById('dmChatMessages');
    container.innerHTML = messages.map(msg => `
      <div class="chat-bubble ${msg.from === USER ? 'mine' : 'others'}">
        ${msg.from !== USER ? `<span class="chat-user">${escapeHtml(msg.from)}</span>` : ''}
        ${msg.image ? `<img src="${API + msg.image}" style="max-width:100%;border-radius:8px;margin-bottom:4px;">` : ''}
        ${msg.text ? `<div>${escapeHtml(msg.text)}</div>` : ''}
      </div>
    `).join('');
    
    container.scrollTop = container.scrollHeight;
  } catch (e) {
    console.error(e);
  }
}

async function sendDM() {
  if (!CURRENT_DM_PARTNER) return;
  
  const input = document.getElementById('dmChatInput');
  const imageInput = document.getElementById('dmImageInput');
  const text = input.value.trim();
  
  if (!text && !imageInput.files[0]) return;
  
  const formData = new FormData();
  formData.append('from', USER);
  formData.append('to', CURRENT_DM_PARTNER);
  formData.append('text', text);
  if (imageInput.files[0]) {
    formData.append('image', imageInput.files[0]);
  }
  
  try {
    const res = await fetch(API + '/api/dm/send', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    
    if (data.success) {
      input.value = '';
      imageInput.value = '';
      await loadDMMessages();
    } else {
      showToast(data.msg || "Error sending message", "error");
    }
  } catch (e) {
    console.error(e);
    showToast("Error sending message", "error");
  }
}

// === Room Functions ===
async function createRoom() {
  const name = await showModal({
    type: 'input',
    title: 'Create Private Room',
    description: 'Enter a name for your private room:',
    placeholder: 'Room name...'
  });
  
  if (!name) return;
  
  try {
    const res = await fetch(API + '/api/room/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, username: USER })
    });
    const data = await res.json();
    
    if (data.success) {
      showToast("Room created!", "success");
      loadRooms();
    } else {
      showToast(data.msg || "Error creating room", "error");
    }
  } catch (e) {
    console.error(e);
    showToast("Error creating room", "error");
  }
}

async function openRoomChat(roomId) {
  CURRENT_ROOM_ID = roomId;
  
  try {
    const res = await fetch(API + `/api/room/${roomId}`);
    const room = await res.json();
    
    document.getElementById('roomChatName').innerText = room.name || 'Room';
    document.getElementById('roomMemberCount').innerText = `${room.members?.length || 0} members`;
    document.getElementById('roomChatModal').style.display = 'flex';
    document.getElementById('roomChatInput').value = '';
    
    await loadRoomMessages();
    
    // Start polling
    if (ROOM_POLL_INTERVAL) clearInterval(ROOM_POLL_INTERVAL);
    ROOM_POLL_INTERVAL = setInterval(loadRoomMessages, 3000);
  } catch (e) {
    console.error(e);
    showToast("Error opening room", "error");
  }
}

function closeRoomChat() {
  document.getElementById('roomChatModal').style.display = 'none';
  CURRENT_ROOM_ID = null;
  if (ROOM_POLL_INTERVAL) {
    clearInterval(ROOM_POLL_INTERVAL);
    ROOM_POLL_INTERVAL = null;
  }
}

async function loadRoomMessages() {
  if (!CURRENT_ROOM_ID) return;
  
  try {
    const res = await fetch(API + `/api/room/${CURRENT_ROOM_ID}/messages?username=${USER}`);
    const messages = await res.json();
    
    const container = document.getElementById('roomChatMessages');
    container.innerHTML = messages.map(msg => `
      <div class="chat-bubble ${msg.sender === USER ? 'mine' : 'others'}">
        ${msg.sender !== USER ? `<span class="chat-user">${escapeHtml(msg.sender)}</span>` : ''}
        ${msg.image ? `<img src="${API + msg.image}" style="max-width:100%;border-radius:8px;margin-bottom:4px;">` : ''}
        ${msg.text ? `<div>${escapeHtml(msg.text)}</div>` : ''}
      </div>
    `).join('');
    
    container.scrollTop = container.scrollHeight;
  } catch (e) {
    console.error(e);
  }
}

async function sendRoomMessage() {
  if (!CURRENT_ROOM_ID) return;
  
  const input = document.getElementById('roomChatInput');
  const imageInput = document.getElementById('roomImageInput');
  const text = input.value.trim();
  
  if (!text && !imageInput.files[0]) return;
  
  const formData = new FormData();
  formData.append('username', USER);
  formData.append('text', text);
  if (imageInput.files[0]) {
    formData.append('image', imageInput.files[0]);
  }
  
  try {
    const res = await fetch(API + `/api/room/${CURRENT_ROOM_ID}/send`, {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    
    if (data.success) {
      input.value = '';
      imageInput.value = '';
      await loadRoomMessages();
    } else {
      showToast(data.msg || "Error sending message", "error");
    }
  } catch (e) {
    console.error(e);
    showToast("Error sending message", "error");
  }
}

async function openInviteModal() {
  // Load verified admins to invite
  try {
    const res = await fetch(API + `/api/verified-admins?username=${USER}`);
    const admins = await res.json();
    
    // Get current room members to exclude them
    const roomRes = await fetch(API + `/api/room/${CURRENT_ROOM_ID}`);
    const room = await roomRes.json();
    const currentMembers = room.members || [];
    
    const availableAdmins = admins.filter(a => 
      a.username !== USER && !currentMembers.includes(a.username)
    );
    
    // Create multi-select modal with manual input option
    const modalHtml = `
      <div class="modalBg" id="inviteModal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:5000;">
        <div class="modal" style="background:white;padding:24px;border-radius:16px;width:450px;max-height:80vh;overflow:auto;">
          <h3 style="margin-top:0;">Invite Users to Room</h3>
          
          <!-- Manual username input -->
          <div style="margin-bottom:20px;padding:16px;background:#f9f9f9;border-radius:12px;">
            <label style="font-weight:600;display:block;margin-bottom:8px;">Enter username manually:</label>
            <div style="display:flex;gap:8px;">
              <input type="text" id="manualUsernameInput" placeholder="Enter username..." style="flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;">
              <button onclick="validateAndAddUsername()" style="padding:10px 16px;background:var(--gradient-primary);color:white;border:none;border-radius:8px;cursor:pointer;">Add</button>
            </div>
            <p id="usernameValidationMsg" style="margin:8px 0 0;font-size:13px;display:none;"></p>
          </div>
          
          <!-- Manual added users list -->
          <div id="manualUsersList" style="margin-bottom:16px;"></div>
          
          ${availableAdmins.length > 0 ? `
            <p style="color:#666;margin-bottom:12px;">Or select from verified admins:</p>
            <div id="inviteAdminsList" style="max-height:200px;overflow-y:auto;">
              ${availableAdmins.map(admin => `
                <label style="display:flex;align-items:center;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all 0.2s;">
                  <input type="checkbox" value="${admin.username}" style="margin-right:12px;width:18px;height:18px;">
                  <img src="${admin.avatar ? API + admin.avatar : 'https://via.placeholder.com/40'}" style="width:40px;height:40px;border-radius:50%;margin-right:12px;" onerror="this.src='https://via.placeholder.com/40'">
                  <div>
                    <div style="font-weight:600;">${escapeHtml(admin.username)}</div>
                    <div style="font-size:12px;color:#666;">${admin.communities.map(c => 'r/' + c).join(', ')}</div>
                  </div>
                </label>
              `).join('')}
            </div>
          ` : '<p style="color:#666;">No verified admins available to select.</p>'}
          
          <div style="display:flex;gap:12px;margin-top:20px;justify-content:flex-end;">
            <button onclick="document.getElementById('inviteModal').remove()" style="padding:10px 20px;background:#f0f0f0;border:none;border-radius:8px;cursor:pointer;">Cancel</button>
            <button onclick="inviteSelectedAdmins()" style="padding:10px 20px;background:var(--gradient-primary);color:white;border:none;border-radius:8px;cursor:pointer;">Invite Selected</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Store manual users
    window.manualInviteUsers = [];
    
  } catch (e) {
    console.error(e);
    showToast("Error loading admins", "error");
  }
}

async function validateAndAddUsername() {
  const input = document.getElementById('manualUsernameInput');
  const msgEl = document.getElementById('usernameValidationMsg');
  const username = input.value.trim();
  
  if (!username) {
    msgEl.style.display = 'block';
    msgEl.style.color = 'red';
    msgEl.textContent = 'Please enter a username';
    return;
  }
  
  // Check if already added
  if (window.manualInviteUsers.includes(username)) {
    msgEl.style.display = 'block';
    msgEl.style.color = 'red';
    msgEl.textContent = 'Username already added';
    return;
  }
  
  // Validate username exists in database
  msgEl.style.display = 'block';
  msgEl.style.color = '#666';
  msgEl.textContent = 'Validating...';
  
  try {
    const res = await fetch(API + `/api/user/validate/${encodeURIComponent(username)}`);
    const data = await res.json();
    
    if (!data.exists) {
      msgEl.style.display = 'block';
      msgEl.style.color = 'red';
      msgEl.style.fontWeight = 'bold';
      msgEl.textContent = '❌ Invalid username - user not found in database';
      return;
    }
    
    // Valid user - add to list
    window.manualInviteUsers.push(username);
    input.value = '';
    msgEl.style.display = 'block';
    msgEl.style.color = 'green';
    msgEl.style.fontWeight = 'normal';
    msgEl.textContent = `✓ ${username} added`;
    
    // Update manual users display
    updateManualUsersList();
    
    // Clear success message after 2 seconds
    setTimeout(() => {
      if (msgEl.style.color === 'green') {
        msgEl.style.display = 'none';
      }
    }, 2000);
    
  } catch (e) {
    console.error(e);
    msgEl.style.display = 'block';
    msgEl.style.color = 'red';
    msgEl.textContent = 'Error validating username';
  }
}

function updateManualUsersList() {
  const container = document.getElementById('manualUsersList');
  if (window.manualInviteUsers.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = `
    <p style="font-weight:600;margin-bottom:8px;">Users to invite:</p>
    ${window.manualInviteUsers.map(u => `
      <span style="display:inline-flex;align-items:center;background:#e0e7ff;padding:6px 12px;border-radius:16px;margin:4px;font-size:13px;">
        ${escapeHtml(u)}
        <button onclick="removeManualUser('${u}')" style="background:none;border:none;margin-left:6px;cursor:pointer;font-size:16px;">×</button>
      </span>
    `).join('')}
  `;
}

function removeManualUser(username) {
  window.manualInviteUsers = window.manualInviteUsers.filter(u => u !== username);
  updateManualUsersList();
}


async function inviteSelectedAdmins() {
  // Get checkbox selected admins
  const checkboxes = document.querySelectorAll('#inviteAdminsList input[type="checkbox"]:checked');
  const checkboxAdmins = Array.from(checkboxes).map(cb => cb.value);
  
  // Combine with manually added users
  const manualUsers = window.manualInviteUsers || [];
  const allUsers = [...new Set([...checkboxAdmins, ...manualUsers])]; // Remove duplicates
  
  if (allUsers.length === 0) {
    showToast("Please select or add at least one user", "error");
    return;
  }
  
  let successCount = 0;
  let failCount = 0;
  let invalidUsers = [];
  
  for (const invitee of allUsers) {
    try {
      const res = await fetch(API + '/api/room/invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roomId: CURRENT_ROOM_ID, username: USER, invitee })
      });
      const data = await res.json();
      
      if (data.success) {
        successCount++;
      } else {
        failCount++;
        if (data.invalidUser) {
          invalidUsers.push(invitee);
        }
      }
    } catch (e) {
      failCount++;
    }
  }
  
  // Remove modal
  document.getElementById('inviteModal').remove();
  
  // Show result
  if (successCount > 0) {
    showToast(`Invited ${successCount} user${successCount > 1 ? 's' : ''} successfully!`, "success");
    // Refresh room
    openRoomChat(CURRENT_ROOM_ID);
  }
  if (invalidUsers.length > 0) {
    showToast(`Invalid username${invalidUsers.length > 1 ? 's' : ''}: ${invalidUsers.join(', ')}`, "error");
  } else if (failCount > 0) {
    showToast(`Failed to invite ${failCount} user${failCount > 1 ? 's' : ''}`, "error");
  }
}


document.addEventListener('DOMContentLoaded', () => {
    // If not already loading/loaded within a logical timeframe, force it.
    // But loadGroups calls it. Let's just double check.
    if(document.getElementById("selTitle").innerText === "Popular Posts" && document.getElementById("postsHere").innerHTML === "") {
        loadHomeFeed();
    }
});
</script>
</body>
</html>
